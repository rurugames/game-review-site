<div class="search-page">
  <div class="search-hero">
    <form id="searchForm" action="/search" method="get" class="search-form-hero">
      <div class="search-main">
        <input type="search" name="q" value="<%= query %>" placeholder="ゲームタイトル、サークル名、キーワードを検索" aria-label="検索" />
        <button type="submit" class="btn-primary">検索</button>
      </div>

      <div class="filter-bar">
        <div class="filter-grid">
          <div class="filter-item">
            <label class="filter-label">ジャンル</label>
            <select name="genre">
              <option value="">すべて</option>
              <% if (typeof genres !== 'undefined') { %>
                <% genres.forEach(function(g){ %>
                  <option value="<%= g %>" <%= (filters && filters.genre === g) ? 'selected' : '' %>><%= g %></option>
                <% }); %>
              <% } %>
            </select>
          </div>

          <div class="filter-item">
            <label class="filter-label">価格 (¥)</label>
            <div class="price-inputs">
              <input type="number" name="minPrice" placeholder="最小" value="<%= filters && filters.minPrice ? filters.minPrice : '' %>" />
              <span class="sep">〜</span>
              <input type="number" name="maxPrice" placeholder="最大" value="<%= filters && filters.maxPrice ? filters.maxPrice : '' %>" />
            </div>
          </div>

          <div class="filter-item">
            <label class="filter-label">リリース日</label>
            <div class="date-inputs">
              <input type="date" name="fromDate" value="<%= filters && filters.fromDate ? filters.fromDate : '' %>" />
              <span class="sep">〜</span>
              <input type="date" name="toDate" value="<%= filters && filters.toDate ? filters.toDate : '' %>" />
            </div>
          </div>
        </div>

        <div class="filter-actions">
          <button type="submit" class="btn-primary">適用</button>
          <button type="button" id="clearFilters" class="btn-secondary">クリア</button>
        </div>
      </div>
    </form>

    <div class="search-summary">
      <% if (query && query.length) { %>
        <h2>「<%= query %>」 の検索結果</h2>
        <p class="result-count"><%= total %> 件の結果</p>
      <% } else { %>
        <h2>検索</h2>
        <p class="result-count">キーワードを入力して検索してください</p>
      <% } %>
    </div>
  </div>
  <script>
    // Clear filter inputs and submit empty filters (keeps query text)
    (function(){
      const clearBtn = document.getElementById('clearFilters');
      if (!clearBtn) return;
      clearBtn.addEventListener('click', function(){
        const form = document.getElementById('searchForm');
        if (!form) return;
        // Clear select/number/date inputs and submit
        const inputs = form.querySelectorAll('select[name], input[name]');
        inputs.forEach(i => {
          if (i.name === 'q') return; // keep query
          if (i.type === 'checkbox' || i.type === 'radio') i.checked = false;
          else i.value = '';
        });
        form.submit();
      });
    }());
  </script>

  <div class="search-results">
    <% if (articles && articles.length) { %>
      <section class="results-section">
        <h3>記事</h3>
        <div class="articles-grid">
          <% articles.forEach(function(a){ %>
            <article class="article-card">
              <div class="article-image">
                <% if (a.featuredImage) { %>
                  <img src="<%= a.featuredImage %>" alt="<%= a.title %>">
                <% } else { %>
                  <img src="/images/siteicon.png" alt="placeholder">
                <% } %>
              </div>
              <div class="article-content">
                <div class="article-meta">
                  <span class="date"><%= new Date(a.createdAt).toLocaleDateString() %></span>
                </div>
                <h2><a href="/articles/<%= a._id %>"><%- a._highlightTitle || a.title %></a></h2>
                <p class="description"><%- a._highlight || ( (a.excerpt || a.description || '').slice(0, 220) + '...') %></p>
                <div class="article-footer">
                  <a href="/articles/<%= a._id %>" class="btn-read-more">続きを読む</a>
                </div>
              </div>
            </article>
          <% }); %>
        </div>
      </section>
    <% } %>

    <% if (games && games.length) { %>
      <section class="results-section">
        <h3>該当する作品（ランキングから）</h3>
        <div class="ranking-grid ranking-tiles">
          <% games.forEach(function(g, idx){ %>
            <div class="ranking-item">
              <div class="rank-badge rank-<%= (idx+1) <= 3 ? (idx+1) : 4 %>"><%= idx+1 %></div>
              <div class="ranking-image">
                <% if (g.image) { %>
                  <img src="<%= g.image %>" alt="<%= g.title %>">
                <% } else { %>
                  <img src="/images/siteicon.png" alt="cover">
                <% } %>
              </div>
              <div class="ranking-content">
                <div class="ranking-circle"><%= g.genre || '' %></div>
                <div class="ranking-game-title"><a href="<%= g.url || '#' %>"><%- g._titleHighlighted || g.title %></a></div>
                <div class="description" style="color:var(--text-secondary); font-size:0.95rem; margin-top:0.5rem;"><%= g.circle ? 'サークル：' + g.circle : '' %></div>
                <% if (g.price) { %>
                  <div style="margin-top:0.75rem;"><a class="btn-dlsite-small" href="<%= g.url || '#' %>">価格：<%= g.price %></a></div>
                <% } %>
              </div>
            </div>
          <% }); %>
        </div>
      </section>
    <% } %>

    <% if ((!articles || !articles.length) && (!games || !games.length)) { %>
      <div class="no-articles" style="margin-top:2rem;">
        <p>検索結果は見つかりませんでした。別のキーワードでお試しください。</p>
        <p style="margin-top:1rem;"><a href="/" class="btn-back">ホームに戻る</a></p>
      </div>
    <% } %>
  </div>
</div>
