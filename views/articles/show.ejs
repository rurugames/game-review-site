<article class="article-detail">
  <div class="article-header">
    <div class="breadcrumb">
      <a href="/">ホーム</a> / <span><%= article.gameTitle %></span>
    </div>
    
    <% if (article.imageUrl) { %>
      <div class="featured-image">
        <img src="<%= article.imageUrl %>" alt="<%= article.gameTitle %>">
      </div>
    <% } %>

    <div class="article-meta-header">
      <span class="genre"><%= article.genre || 'ゲーム' %></span>
      <% if (article.rating) { %>
        <span class="rating-large"><%= '★'.repeat(article.rating) + '☆'.repeat(10 - article.rating) %></span>
      <% } %>
    </div>

    <h1><%= article.title %></h1>
    <h2 class="game-title-large"><%= article.gameTitle %></h2>

    <div class="game-info">
      <% if (article.developer) { %>
        <div class="info-item">
          <strong>開発元:</strong> <%= article.developer %>
        </div>
      <% } %>
      <% if (article.platform) { %>
        <div class="info-item">
          <strong>プラットフォーム:</strong> <%= article.platform %>
        </div>
      <% } %>
      <% if (article.releaseDate) { %>
        <div class="info-item">
          <strong>発売日:</strong> <%= new Date(article.releaseDate).toLocaleDateString('ja-JP') %>
        </div>
      <% } %>
    </div>

    <div class="author-date">
      <div class="author-info">
        <img src="<%= article.author.image %>" alt="<%= article.author.email === 'hiderance1919@gmail.com' ? '管理者' : article.author.displayName %>" class="author-avatar">
        <div>
          <div class="author-name"><%= article.author.email === 'hiderance1919@gmail.com' ? '管理者' : article.author.displayName %></div>
          <div class="article-date">
            投稿: <%= new Date(article.createdAt).toLocaleDateString('ja-JP') %>
            <% if (article.createdAt.getTime() !== article.updatedAt.getTime()) { %>
              | 更新: <%= new Date(article.updatedAt).toLocaleDateString('ja-JP') %>
            <% } %>
          </div>
        </div>
      </div>
      <div class="views-count">👁️ <%= article.views %> 閲覧</div>
    </div>

    <% if (user && user.email === 'hiderance1919@gmail.com') { %>
      <div class="article-actions">
        <a href="/articles/<%= article._id %>/edit" class="btn-edit">編集</a>
        <form action="/articles/<%= article._id %>?_method=DELETE" method="POST" style="display:inline;">
          <button type="submit" class="btn-delete" onclick="return confirm('本当に削除しますか？')">削除</button>
        </form>
      </div>
    <% } %>
  </div>

  <div class="article-body">
    <div class="description">
      <p><%= article.description %></p>
    </div>

    <div class="content">
      <%- article.contentHtml %>
    </div>

    <% if (article.tags && article.tags.length > 0) { %>
      <div class="tags">
        <strong>タグ:</strong>
        <% article.tags.forEach(tag => { %>
          <span class="tag">#<%= tag %></span>
        <% }); %>
      </div>
    <% } %>

    <% if (article.affiliateLink) { %>
      <div class="affiliate-section">
        <h3>このゲームを購入</h3>
        <a href="<%= article.affiliateLink %>" target="_blank" rel="noopener noreferrer" class="btn-affiliate">
          🛒 購入ページへ
        </a>
      </div>
    <% } %>

    <div class="banner-article">
      <a rel="noopener" href="https://www.dlsite.com/maniax/?utm_medium=affiliate&utm_campaign=bnlink&utm_content=bn_sp_300_250_dojin_01.gif" target="_blank">
        <img src="https://www.dlsite.com/img/male/dojin/bn_sp_300_250_dojin_01.gif" alt="同人誌、同人ゲーム、同人ソフトのダウンロードショップ - DLsite" width="300" height="250" border="0" />
      </a>
    </div>
  </div>

  <div class="article-footer-nav">
    <a href="/" class="btn-back">← 記事一覧に戻る</a>
  </div>
</article>

<!-- コメントセクション -->
<section class="comments-section">
  <h2 class="comments-title">💬 コメント (<%= comments.length %>)</h2>

  <% if (user) { %>
    <!-- コメント投稿フォーム -->
    <div class="comment-form-container">
      <h3>コメントを投稿</h3>
      <form action="/comments/<%= article._id %>" method="POST" class="comment-form">
        <div class="form-group">
          <textarea name="content" rows="4" placeholder="コメントを入力してください..." required></textarea>
        </div>
        <button type="submit" class="btn-primary">コメントを投稿</button>
      </form>
    </div>
  <% } else { %>
    <div class="comment-login-prompt">
      <p>コメントを投稿するには<a href="/auth/google">ログイン</a>してください</p>
    </div>
  <% } %>

  <!-- コメント一覧 -->
  <div class="comments-list">
    <% if (comments.length > 0) { %>
      <% comments.forEach(comment => { %>
        <div class="comment-item">
          <div class="comment-header">
            <img src="<%= comment.author.image %>" alt="<%= comment.author.email === 'hiderance1919@gmail.com' ? '管理者' : comment.author.displayName %>" class="comment-avatar">
            <div class="comment-meta">
              <span class="comment-author"><%= comment.author.email === 'hiderance1919@gmail.com' ? '管理者' : comment.author.displayName %></span>
              <span class="comment-date"><%= new Date(comment.createdAt).toLocaleDateString('ja-JP') %> <%= new Date(comment.createdAt).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) %></span>
            </div>
            <% if (user && (comment.author._id.toString() === user.id || user.email === 'hiderance1919@gmail.com')) { %>
              <form action="/comments/<%= comment._id %>?_method=DELETE" method="POST" class="comment-delete-form">
                <button type="submit" class="btn-comment-delete" onclick="return confirm('コメントを削除しますか？')">🗑️</button>
              </form>
            <% } %>
          </div>
          <div class="comment-content">
            <%= comment.content %>
          </div>
        </div>
      <% }); %>
    <% } else { %>
      <div class="no-comments">
        <p>まだコメントがありません。最初のコメントを投稿してみましょう！</p>
      </div>
    <% } %>
  </div>
</section>
