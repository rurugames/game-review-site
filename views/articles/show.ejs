<article class="article-detail" data-article-id="<%= article._id %>">
  <div class="article-header">
    <div class="breadcrumb">
      <a href="/">ホーム</a> / <span><%= article.gameTitle %></span>
    </div>
    
    <% if (article.imageUrl) { %>
      <div class="featured-image">
        <img src="<%= article.imageUrl %>" alt="<%= article.gameTitle %>">
      </div>
    <% } %>

    <div class="article-meta-header">
      <span class="genre"><%= article.genre || 'ゲーム' %></span>
      <% if (article.rating) { %>
        <span class="rating-large"><%= '★'.repeat(article.rating) + '☆'.repeat(10 - article.rating) %></span>
      <% } %>
    </div>

    <h1><%= article.title %></h1>
    <h2 class="game-title-large"><%= article.gameTitle %></h2>

    <div class="game-info">
      <% if (article.developer) { %>
        <div class="info-item">
          <strong>開発元:</strong> <%= article.developer %>
        </div>
      <% } %>
      <% if (article.platform) { %>
        <div class="info-item">
          <strong>プラットフォーム:</strong> <%= article.platform %>
        </div>
      <% } %>
      <% if (article.releaseDate) { %>
        <div class="info-item">
          <strong>発売日:</strong> <%= new Date(article.releaseDate).toLocaleDateString('ja-JP') %>
        </div>
      <% } %>
    </div>

    <div class="author-date">
      <div class="author-info">
        <img src="<%= article.author.image %>" alt="<%= (adminDisplayNames && adminDisplayNames[article.author.email]) ? adminDisplayNames[article.author.email] : article.author.displayName %>" class="author-avatar">
        <div>
          <div class="author-name"><%= (adminDisplayNames && adminDisplayNames[article.author.email]) ? adminDisplayNames[article.author.email] : article.author.displayName %></div>
          <div class="article-date">
            投稿: <%= new Date(article.createdAt).toLocaleDateString('ja-JP') %>
            <% if (article.createdAt.getTime() !== article.updatedAt.getTime()) { %>
              | 更新: <%= new Date(article.updatedAt).toLocaleDateString('ja-JP') %>
            <% } %>
          </div>
        </div>
      </div>
      <div class="views-count">👁️ <%= article.views %> 閲覧</div>
    </div>

    <div class="article-actions">
      <div
        class="share-menu-wrap"
        data-share-wrap="1"
        data-share-url="<%= canonicalUrl %>"
        data-share-text="<%= (article && (article.title || article.gameTitle)) ? (article.title || article.gameTitle) : '' %>"
      >
        <button
          type="button"
          class="share-btn"
          data-share-toggle="1"
          aria-label="共有"
          aria-haspopup="true"
          aria-expanded="false"
        >
          <span class="share-btn-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="18" height="18" focusable="false" aria-hidden="true">
              <path d="M14 3l7 7-7 7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M21 10H10a7 7 0 0 0-7 7v4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </span>
          <span class="share-btn-label">共有</span>
        </button>

        <div class="share-menu" data-share-menu="1" hidden>
          <a href="#" class="share-menu-item" data-share-line="1" target="_blank" rel="noopener noreferrer">
            <span class="share-menu-icon" aria-hidden="true">💬</span>
            <span class="share-menu-label">LINEで共有</span>
          </a>
          <a href="#" class="share-menu-item" data-share-x="1" target="_blank" rel="noopener noreferrer">
            <span class="share-menu-icon" aria-hidden="true">𝕏</span>
            <span class="share-menu-label">Xで共有</span>
          </a>
          <button type="button" class="share-menu-item" data-share-copy="1">
            <span class="share-menu-icon" aria-hidden="true">🔗</span>
            <span class="share-menu-label">URLをコピー</span>
          </button>
        </div>
      </div>
    </div>

    <% if (isAdmin) { %>
      <div class="article-actions">
        <a href="/articles/<%= article._id %>/edit" class="btn-edit">編集</a>
        <form action="/articles/<%= article._id %>?_method=DELETE" method="POST" style="display:inline;">
          <button type="submit" class="btn-delete" onclick="return confirm('本当に削除しますか？')">削除</button>
        </form>
      </div>
    <% } %>
  </div>

  <div class="article-body">
    <div class="description">
      <p><%= article.description %></p>
    </div>

    <div class="content">
      <%- article.contentHtml %>
    </div>

    <% if (article.tags && article.tags.length > 0) { %>
      <div class="tags">
        <strong>タグ:</strong>
        <% article.tags.forEach(tag => { %>
          <a class="tag" href="/articles?tags=<%= encodeURIComponent(tag) %>">#<%= tag %></a>
        <% }); %>
      </div>
    <% } %>

    <% if (article.affiliateLink) { %>
      <div class="affiliate-section">
        <h3>このゲームを購入</h3>
        <a href="<%= article.affiliateLink %>" target="_blank" rel="noopener noreferrer sponsored" class="btn-affiliate">
          🛒 購入ページへ
        </a>
      </div>
    <% } %>

    <% if ((compareTopByGenreReviews && compareTopByGenreReviews.length > 0) || (compareTrendingByTags && compareTrendingByTags.length > 0)) { %>
      <section class="articles-section page-section" aria-label="比較して探す">
        <div class="page-header">
          <h2 class="section-title">比較して探す</h2>
          <p class="section-lead">似た作品を並べて見て、買う判断をしやすくします。</p>
        </div>
        <div class="panel">
          <div class="panel-body">
            <% if (compareTopByGenreReviews && compareTopByGenreReviews.length > 0) { %>
              <div style="margin-bottom:1.25rem;">
                <h3 style="margin:0 0 0.25rem;">同ジャンルで評価が高い</h3>
                <p style="margin:0 0 0.75rem; opacity:0.85;">短評レビューの評価（件数補正あり）が高い作品です。</p>
                <div class="articles-grid">
                  <% compareTopByGenreReviews.slice(0, 6).forEach(function(a){ %>
                    <article class="article-card">
                      <% if (a.imageUrl) { %>
                        <div class="article-image">
                          <img src="<%= a.imageUrl %>" alt="<%= a.gameTitle || a.title %>">
                        </div>
                      <% } %>
                      <div class="article-content">
                        <div class="article-meta">
                          <span class="genre"><%= a.genre || 'ゲーム' %></span>
                          <span class="date">レビュー <%= a.reviewCount || 0 %>件 / ★<%= Number(a.bayesScore ?? a.reviewAvg ?? 0).toFixed(2) %></span>
                        </div>
                        <h2><%= a.title %></h2>
                        <h3 class="game-title"><%= a.gameTitle %></h3>
                        <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
                          <a href="/articles/<%= a._id %>" class="btn-read-more">比較する</a>
                          <% if (a.affiliateLink) { %>
                            <a href="<%= a.affiliateLink %>" target="_blank" rel="noopener noreferrer sponsored" class="btn-secondary" style="padding:0.5rem 1rem;">購入</a>
                          <% } %>
                        </div>
                      </div>
                    </article>
                  <% }); %>
                </div>
              </div>
            <% } %>

            <% if (compareTrendingByTags && compareTrendingByTags.length > 0) { %>
              <div>
                <h3 style="margin:0 0 0.25rem;">同タグで最近レビューが増えている</h3>
                <p style="margin:0 0 0.75rem; opacity:0.85;">直近30日で短評レビューが増えている作品です。</p>
                <div class="articles-grid">
                  <% compareTrendingByTags.slice(0, 6).forEach(function(a){ %>
                    <article class="article-card">
                      <% if (a.imageUrl) { %>
                        <div class="article-image">
                          <img src="<%= a.imageUrl %>" alt="<%= a.gameTitle || a.title %>">
                        </div>
                      <% } %>
                      <div class="article-content">
                        <div class="article-meta">
                          <span class="genre"><%= a.genre || 'ゲーム' %></span>
                          <span class="date">直近30日 +<%= a.recentReviewCount || 0 %></span>
                        </div>
                        <h2><%= a.title %></h2>
                        <h3 class="game-title"><%= a.gameTitle %></h3>
                        <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
                          <a href="/articles/<%= a._id %>" class="btn-read-more">比較する</a>
                          <% if (a.affiliateLink) { %>
                            <a href="<%= a.affiliateLink %>" target="_blank" rel="noopener noreferrer sponsored" class="btn-secondary" style="padding:0.5rem 1rem;">購入</a>
                          <% } %>
                        </div>
                      </div>
                    </article>
                  <% }); %>
                </div>
              </div>
            <% } %>
          </div>
        </div>
      </section>
    <% } %>

    <% if (relatedVideos && relatedVideos.length > 0) { %>
      <section class="articles-section page-section" aria-label="関連動画">
        <div class="page-header">
          <h2 class="section-title">関連動画</h2>
          <p class="section-lead">タイトルの単語から関連動画を探しました。</p>
        </div>
        <div class="panel">
          <div class="panel-body">
            <div class="articles-grid">
              <% relatedVideos.forEach(function(v){ %>
                <article class="article-card">
                  <% if (v.thumbnailUrl) { %>
                    <div class="article-image">
                      <a href="<%= v.url %>" target="_blank" rel="noopener noreferrer">
                        <img src="<%= v.thumbnailUrl %>" alt="<%= v.title %>">
                      </a>
                    </div>
                  <% } %>
                  <div class="article-content">
                    <div class="article-meta">
                      <span class="genre">YouTube</span>
                      <% if (v.publishedAtJp) { %>
                        <span class="date"><%= v.publishedAtJp %></span>
                      <% } %>
                    </div>
                    <h2>
                      <a href="<%= v.url %>" target="_blank" rel="noopener noreferrer"><%= v.title %></a>
                    </h2>
                    <% if (v.shortDescription) { %>
                      <p class="description"><%= v.shortDescription %></p>
                    <% } %>
                    <a href="<%= v.url %>" target="_blank" rel="noopener noreferrer" class="btn-read-more">動画を見る</a>
                  </div>
                </article>
              <% }); %>
            </div>
          </div>
        </div>
      </section>
    <% } %>

    <section class="articles-section page-section" aria-label="同属性のおすすめ">
      <div class="page-header">
        <h2 class="section-title">同属性のおすすめ3本</h2>
        <p class="section-lead"><%= (article.genre && String(article.genre).trim()) ? (String(article.genre).trim() + ' の記事') : '関連する記事' %>をピックアップしました。</p>
      </div>
      <div class="panel">
        <div class="panel-body">
          <% if (recommendedSameAttribute && recommendedSameAttribute.length > 0) { %>
            <div class="articles-grid">
              <% recommendedSameAttribute.slice(0, 3).forEach(function(a, idx){ %>
                <article class="article-card">
                  <% if (a.imageUrl) { %>
                    <div class="article-image">
                      <img src="<%= a.imageUrl %>" alt="<%= a.gameTitle || a.title %>">
                    </div>
                  <% } %>
                  <div class="article-content">
                    <div class="article-meta">
                      <span class="genre"><%= a.genre || 'ゲーム' %></span>
                      <% if (a.rating) { %>
                        <span class="rating"><%= '★'.repeat(a.rating) + '☆'.repeat(10 - a.rating) %></span>
                      <% } %>
                    </div>
                    <h2><%= a.title %></h2>
                    <h3 class="game-title"><%= a.gameTitle %></h3>
                    <% if (a.description) { %>
                      <p class="description"><%= String(a.description).substring(0, 150) %>...</p>
                    <% } %>
                    <div class="article-footer">
                      <% if (a.author) { %>
                        <div class="author-info">
                          <img src="<%= a.author.image %>" alt="<%= (adminDisplayNames && adminDisplayNames[a.author.email]) ? adminDisplayNames[a.author.email] : a.author.displayName %>" class="author-avatar">
                          <span><%= (adminDisplayNames && adminDisplayNames[a.author.email]) ? adminDisplayNames[a.author.email] : a.author.displayName %></span>
                        </div>
                      <% } %>
                      <span class="date"><%= a.createdAt ? new Date(a.createdAt).toLocaleDateString('ja-JP') : '' %></span>
                    </div>
                    <a
                      href="/articles/<%= a._id %>"
                      class="btn-read-more"
                      data-related-click="1"
                      data-related-block="same_attribute"
                      data-related-position="<%= idx + 1 %>"
                      data-to-article-id="<%= a._id %>"
                    >続きを読む</a>
                  </div>
                </article>
              <% }); %>
            </div>
          <% } else { %>
            <div class="no-articles">
              <p>同属性のおすすめ記事がまだありません。</p>
            </div>
          <% } %>
        </div>
      </div>
    </section>

    <section class="articles-section page-section" aria-label="同サークルの他作">
      <div class="page-header">
        <h2 class="section-title">同サークルの他作3本</h2>
        <p class="section-lead"><%= (article.developer && String(article.developer).trim()) ? (String(article.developer).trim() + ' の他の記事') : '同じ制作元の他の記事' %>をピックアップしました。</p>
      </div>
      <div class="panel">
        <div class="panel-body">
          <% if (recommendedSameDeveloper && recommendedSameDeveloper.length > 0) { %>
            <div class="articles-grid">
              <% recommendedSameDeveloper.slice(0, 3).forEach(function(a, idx){ %>
                <article class="article-card">
                  <% if (a.imageUrl) { %>
                    <div class="article-image">
                      <img src="<%= a.imageUrl %>" alt="<%= a.gameTitle || a.title %>">
                    </div>
                  <% } %>
                  <div class="article-content">
                    <div class="article-meta">
                      <span class="genre"><%= a.genre || 'ゲーム' %></span>
                      <% if (a.rating) { %>
                        <span class="rating"><%= '★'.repeat(a.rating) + '☆'.repeat(10 - a.rating) %></span>
                      <% } %>
                    </div>
                    <h2><%= a.title %></h2>
                    <h3 class="game-title"><%= a.gameTitle %></h3>
                    <% if (a.description) { %>
                      <p class="description"><%= String(a.description).substring(0, 150) %>...</p>
                    <% } %>
                    <div class="article-footer">
                      <% if (a.author) { %>
                        <div class="author-info">
                          <img src="<%= a.author.image %>" alt="<%= (adminDisplayNames && adminDisplayNames[a.author.email]) ? adminDisplayNames[a.author.email] : a.author.displayName %>" class="author-avatar">
                          <span><%= (adminDisplayNames && adminDisplayNames[a.author.email]) ? adminDisplayNames[a.author.email] : a.author.displayName %></span>
                        </div>
                      <% } %>
                      <span class="date"><%= a.createdAt ? new Date(a.createdAt).toLocaleDateString('ja-JP') : '' %></span>
                    </div>
                    <a
                      href="/articles/<%= a._id %>"
                      class="btn-read-more"
                      data-related-click="1"
                      data-related-block="same_developer"
                      data-related-position="<%= idx + 1 %>"
                      data-to-article-id="<%= a._id %>"
                    >続きを読む</a>
                  </div>
                </article>
              <% }); %>
            </div>
          <% } else { %>
            <div class="no-articles">
              <p>同サークルの他作記事がまだありません。</p>
            </div>
          <% } %>
        </div>
      </div>
    </section>

    <div class="article-footer-nav">
      <a
        href="<%= (article.tags && article.tags.length > 0) ? ('/articles?tags=' + encodeURIComponent(article.tags.slice(0, 3).join(','))) : '/articles' %>"
        class="btn-back"
      >
        ← 同タグ一覧へ
      </a>
      <a
        href="<%= (article.developer && String(article.developer).trim()) ? ('/articles?q=' + encodeURIComponent(String(article.developer).trim())) : '/articles' %>"
        class="btn-back"
      >
        ← 同サークル一覧へ
      </a>
    </div>

    <div class="banner-article" aria-label="スポンサーリンク">
      <a rel="noopener sponsored" href="https://dlaf.jp/maniax/dlaf/=/aid/r18Hub/url/https%3A%2F%2Fwww.dlsite.com%2Fmaniax%2F%3Futm_medium%3Daffiliate%26utm_campaign%3Dbnlink%26utm_content%3Dbn_sp_300_250_dojin_01.gif" target="_blank">
        <img src="https://www.dlsite.com/img/male/dojin/bn_sp_300_250_dojin_01.gif" alt="同人誌、同人ゲーム、同人ソフトのダウンロードショップ - DLsite" width="300" height="250" border="0" />
      </a>
      <a rel="noopener sponsored" href="https://dlaf.jp/maniax/dlaf/=/aid/r18Hub/url/https%3A%2F%2Fwww.dlsite.com%2Fmaniax%2F%3Futm_medium%3Daffiliate%26utm_campaign%3Dbnlink%26utm_content%3Dbn_sp_300_250_dojin_01.gif" target="_blank">
        <img src="https://www.dlsite.com/img/female/dojin/bn_sp_300_250_dojin_01.gif" alt="同人誌、同人ゲーム、同人ソフトのダウンロードショップ - DLsite" width="300" height="250" border="0" />
      </a>
      <a rel="noopener sponsored" href="https://dlaf.jp/maniax/dlaf/=/aid/r18Hub/url/https%3A%2F%2Fwww.dlsite.com%2Fmaniax%2F%3Futm_medium%3Daffiliate%26utm_campaign%3Dbnlink%26utm_content%3Dbn_sp_300_250_eng_01.gif" target="_blank">
        <img src="https://www.dlsite.com/img/abroad/eng/bn_sp_300_250_eng_01.gif" alt="同人誌、同人ゲーム、同人ソフトのダウンロードショップ - DLsite" width="300" height="250" border="0" />
      </a>
    </div>
  </div>

  <div class="article-footer-nav">
    <a href="/" class="btn-back">← 記事一覧に戻る</a>
  </div>
</article>

<!-- レビュー（短評）セクション -->
<section class="comments-section" id="reviews">
  <h2 class="comments-title">⭐ 短評レビュー（<%= (reviewSummary && reviewSummary.count) ? reviewSummary.count : 0 %>）</h2>

  <div class="panel" style="margin-bottom:1rem;">
    <div class="panel-body">
      <% if (reviewSummary && reviewSummary.count && reviewSummary.count > 0) { %>
        <div style="display:flex; flex-wrap:wrap; gap:1rem; align-items:flex-start;">
          <div>
            <div style="font-size:1.1rem; font-weight:600;">総合評価</div>
            <div style="margin-top:0.25rem;">
              <strong>★<%= Number(reviewSummary.bayesScore ?? reviewSummary.avgRaw ?? 0).toFixed(2) %></strong> / 5
              <span style="opacity:0.8;">（<%= reviewSummary.count %>件）</span>
            </div>
            <% if (reviewSummary.avgRaw != null && reviewSummary.bayesScore != null) { %>
              <div style="opacity:0.8; font-size:0.95rem; margin-top:0.25rem;">
                参考: 単純平均 ★<%= Number(reviewSummary.avgRaw).toFixed(2) %> / 5
              </div>
            <% } %>

            <% if (typeof purchaseConclusion !== 'undefined' && purchaseConclusion) { %>
              <div style="margin-top:0.5rem; line-height:1.6;">
                <strong>結論:</strong> <%= purchaseConclusion %>
              </div>
              <% if (article && article.affiliateLink) { %>
                <div style="margin-top:0.5rem;">
                  <a href="<%= article.affiliateLink %>" target="_blank" rel="noopener noreferrer sponsored" class="btn-affiliate">
                    🛒 購入ページへ
                  </a>
                </div>
              <% } %>
            <% } %>
          </div>

          <div>
            <div style="font-size:1.1rem; font-weight:600;">星の内訳</div>
            <div style="margin-top:0.25rem; line-height:1.6;">
              <div>★★★★★: <%= (reviewSummary.stars && reviewSummary.stars[5]) ? reviewSummary.stars[5] : 0 %></div>
              <div>★★★★☆: <%= (reviewSummary.stars && reviewSummary.stars[4]) ? reviewSummary.stars[4] : 0 %></div>
              <div>★★★☆☆: <%= (reviewSummary.stars && reviewSummary.stars[3]) ? reviewSummary.stars[3] : 0 %></div>
              <div>★★☆☆☆: <%= (reviewSummary.stars && reviewSummary.stars[2]) ? reviewSummary.stars[2] : 0 %></div>
              <div>★☆☆☆☆: <%= (reviewSummary.stars && reviewSummary.stars[1]) ? reviewSummary.stars[1] : 0 %></div>
            </div>
          </div>

          <% if ((reviewSummary.topProsTags && reviewSummary.topProsTags.length) || (reviewSummary.topConsTags && reviewSummary.topConsTags.length)) { %>
            <div>
              <div style="font-size:1.1rem; font-weight:600;">よく出るタグ</div>
              <div style="margin-top:0.25rem; line-height:1.8;">
                <% if (reviewSummary.topProsTags && reviewSummary.topProsTags.length) { %>
                  <div><strong>良い点:</strong> <%= reviewSummary.topProsTags.join(' / ') %></div>
                <% } %>
                <% if (reviewSummary.topConsTags && reviewSummary.topConsTags.length) { %>
                  <div><strong>注意点:</strong> <%= reviewSummary.topConsTags.join(' / ') %></div>
                <% } %>
              </div>
            </div>
          <% } %>
        </div>
      <% } else { %>
        <p style="margin:0;">まだ評価がありません。最初の評価を30秒で残してみましょう。</p>

        <% if (typeof purchaseConclusion !== 'undefined' && purchaseConclusion) { %>
          <p style="margin:0.5rem 0 0; line-height:1.6;"><strong>結論:</strong> <%= purchaseConclusion %></p>
          <% if (article && article.affiliateLink) { %>
            <div style="margin-top:0.5rem;">
              <a href="<%= article.affiliateLink %>" target="_blank" rel="noopener noreferrer sponsored" class="btn-affiliate">
                🛒 購入ページへ
              </a>
            </div>
          <% } %>
        <% } %>
      <% } %>
    </div>
  </div>

  <% if (user) { %>
    <div class="comment-form-container">
      <h3><%= (myReview ? 'あなたの評価（編集）' : '30秒で評価を残す' ) %></h3>

      <% if (typeof reviewPostFeedback !== 'undefined' && reviewPostFeedback) { %>
        <div class="panel" style="margin:0.75rem 0;">
          <div class="panel-body">
            <p style="margin:0; font-weight:600;">ありがとうございます。<%= (reviewPostFeedback.action === 'updated') ? '更新' : '投稿' %>が反映されました。</p>
            <p style="margin:0.25rem 0 0; opacity:0.85;">
              <% if (reviewPostFeedback.rating) { %>
                あなたの評価: <strong><%= '★'.repeat(Number(reviewPostFeedback.rating)) + '☆'.repeat(5 - Number(reviewPostFeedback.rating)) %></strong>
                <% if (reviewSummary && reviewSummary.count) { %>
                  / 現在の総合評価: <strong>★<%= Number(reviewSummary.bayesScore ?? reviewSummary.avgRaw ?? 0).toFixed(2) %></strong>（<%= reviewSummary.count %>件）
                <% } %>
              <% } else { %>
                あなたの評価が「みんなの評価」に反映されました。
              <% } %>
            </p>
            <p style="margin:0.5rem 0 0;">
              <a href="/review-ranking" class="btn-secondary" style="padding:0.25rem 0.5rem;">みんなの評価を見る</a>
            </p>
          </div>
        </div>
      <% } %>

      <form action="/reviews/<%= article._id %>" method="POST" class="comment-form">
        <div class="form-group">
          <label for="review-rating"><strong>評価（★1〜5）</strong></label>
          <select id="review-rating" name="rating" required>
            <% const selectedRating = myReview && myReview.rating ? Number(myReview.rating) : 5; %>
            <% for (let i = 5; i >= 1; i--) { %>
              <option value="<%= i %>" <%= (selectedRating === i) ? 'selected' : '' %>><%= '★'.repeat(i) + '☆'.repeat(5 - i) %></option>
            <% } %>
          </select>
        </div>

        <div class="form-group">
          <label for="review-headline"><strong>短評（200文字以内）</strong></label>
          <p style="margin:0.25rem 0 0.5rem; opacity:0.8; font-size:0.95rem;">
            例: 「良かった点: テンポが良い / 注意点: UIにクセ」など、1行でOKです。
          </p>
          <textarea id="review-headline" name="headline" rows="3" maxlength="200" placeholder="例: 雰囲気が最高、UIは好みが分かれる" required><%= myReview && myReview.headline ? myReview.headline : '' %></textarea>
          <div style="margin-top:0.25rem; opacity:0.75; font-size:0.9rem;">
            残り <span id="review-headline-remaining">200</span> 文字
          </div>
        </div>

        <div class="form-group">
          <label for="review-pros"><strong>良かった点タグ（任意・カンマ区切りで最大3つ）</strong></label>
          <input id="review-pros" type="text" name="prosTags" value="<%= (myReview && myReview.prosTags && myReview.prosTags.length) ? myReview.prosTags.join(', ') : '' %>" placeholder="例: 一本道, テンポ良い, 世界観" />
        </div>

        <div class="form-group">
          <label for="review-cons"><strong>注意点タグ（任意・カンマ区切りで最大3つ）</strong></label>
          <input id="review-cons" type="text" name="consTags" value="<%= (myReview && myReview.consTags && myReview.consTags.length) ? myReview.consTags.join(', ') : '' %>" placeholder="例: 作業感, 難しい, UI癖" />
        </div>

        <div class="form-group" style="display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
          <div>
            <label for="review-playtime"><strong>プレイ時間（任意）</strong></label>
            <select id="review-playtime" name="playtimeBucket">
              <% const pb = myReview && myReview.playtimeBucket ? String(myReview.playtimeBucket) : ''; %>
              <option value="" <%= pb === '' ? 'selected' : '' %>>未選択</option>
              <option value="lt1" <%= pb === 'lt1' ? 'selected' : '' %>>〜1時間</option>
              <option value="1to5" <%= pb === '1to5' ? 'selected' : '' %>>1〜5時間</option>
              <option value="5to20" <%= pb === '5to20' ? 'selected' : '' %>>5〜20時間</option>
              <option value="20plus" <%= pb === '20plus' ? 'selected' : '' %>>20時間以上</option>
            </select>
          </div>

          <label style="display:flex; align-items:center; gap:0.5rem;">
            <input type="checkbox" name="spoiler" value="1" <%= (myReview && myReview.spoiler) ? 'checked' : '' %> />
            ネタバレあり
          </label>
        </div>

        <div style="display:flex; gap:0.75rem; align-items:center; flex-wrap:wrap;">
          <button type="submit" class="btn-primary"><%= myReview ? '更新して反映' : '評価を反映' %></button>

          <% if (myReview && (myReview._id || myReview.id)) { %>
            <form action="/reviews/<%= myReview._id || myReview.id %>?_method=DELETE" method="POST" style="display:inline;">
              <button type="submit" class="btn-secondary" onclick="return confirm('レビューを削除しますか？')">削除</button>
            </form>
          <% } %>
        </div>
      </form>
    </div>
  <% } else { %>
    <div class="comment-login-prompt">
      <p><a href="/auth/google">ログイン</a>すると、★と短評を30秒で残せます。</p>
    </div>
  <% } %>

  <script>
    (function () {
      var ta = document.getElementById('review-headline');
      var out = document.getElementById('review-headline-remaining');
      if (!ta || !out) return;
      var max = parseInt(ta.getAttribute('maxlength') || '200', 10);
      if (!Number.isFinite(max) || max <= 0) max = 200;
      var update = function () {
        var len = (ta.value || '').length;
        var remain = Math.max(0, max - len);
        out.textContent = String(remain);
      };
      ta.addEventListener('input', update);
      update();
    })();
  </script>

  <div class="comments-list">
    <% if (reviews && reviews.length > 0) { %>
      <% reviews.forEach(r => { %>
        <div class="comment-item" id="review-<%= r._id %>">
          <div class="comment-header">
            <img src="<%= r.author && r.author.image ? r.author.image : '' %>" alt="<%= (r.author && r.author.email && adminDisplayNames && adminDisplayNames[r.author.email]) ? adminDisplayNames[r.author.email] : (r.author && r.author.displayName ? r.author.displayName : 'ユーザー') %>" class="comment-avatar">
            <div class="comment-meta">
              <span class="comment-author"><%= (r.author && r.author.email && adminDisplayNames && adminDisplayNames[r.author.email]) ? adminDisplayNames[r.author.email] : (r.author && r.author.displayName ? r.author.displayName : 'ユーザー') %></span>
              <span class="comment-date"><%= r.createdAt ? new Date(r.createdAt).toLocaleDateString('ja-JP') : '' %></span>
            </div>
          </div>

          <div class="comment-content" style="display:flex; flex-direction:column; gap:0.35rem;">
            <div>
              <strong><%= '★'.repeat(Number(r.rating || 0)) + '☆'.repeat(5 - Number(r.rating || 0)) %></strong>
              <% if (r.spoiler) { %>
                <span style="opacity:0.75;">（ネタバレ）</span>
              <% } %>
            </div>
            <div><%= r.headline %></div>

            <% if ((r.prosTags && r.prosTags.length) || (r.consTags && r.consTags.length) || r.playtimeBucket) { %>
              <div style="opacity:0.85; font-size:0.95rem;">
                <% if (r.playtimeBucket) { %>
                  <span>
                    プレイ時間:
                    <%= (r.playtimeBucket === 'lt1') ? '〜1時間'
                      : (r.playtimeBucket === '1to5') ? '1〜5時間'
                      : (r.playtimeBucket === '5to20') ? '5〜20時間'
                      : (r.playtimeBucket === '20plus') ? '20時間以上'
                      : '' %>
                  </span>
                  <span> / </span>
                <% } %>
                <% if (r.prosTags && r.prosTags.length) { %>
                  <span><strong>良い点:</strong> <%= r.prosTags.join(' / ') %></span>
                <% } %>
                <% if (r.consTags && r.consTags.length) { %>
                  <span><%= (r.prosTags && r.prosTags.length) ? ' / ' : '' %><strong>注意:</strong> <%= r.consTags.join(' / ') %></span>
                <% } %>
              </div>
            <% } %>

            <div style="display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap; margin-top:0.25rem;">
              <% const hc = (typeof r.helpfulCount === 'number') ? r.helpfulCount : (Array.isArray(r.helpfulBy) ? r.helpfulBy.length : 0); %>
              <span style="opacity:0.8;">参考になった: <%= hc %></span>

              <% if (user) { %>
                <form action="/reviews/<%= r._id %>/helpful" method="POST" style="display:inline;">
                  <button type="submit" class="btn-secondary"><%= r.viewerHasHelped ? '取り消す' : '参考になった' %></button>
                </form>
              <% } %>

              <% if (user && ((r.author && r.author._id && r.author._id.toString() === user.id) || isAdmin)) { %>
                <form action="/reviews/<%= r._id %>?_method=DELETE" method="POST" style="display:inline;">
                  <button type="submit" class="btn-secondary" onclick="return confirm('レビューを削除しますか？')">削除</button>
                </form>
              <% } %>
            </div>
          </div>
        </div>
      <% }); %>
    <% } else { %>
      <div class="no-comments">
        <p>まだレビューがありません。</p>
      </div>
    <% } %>
  </div>
</section>

<!-- コメントセクション -->
<section class="comments-section">
  <h2 class="comments-title">💬 コメント (<%= (typeof commentCount !== 'undefined') ? commentCount : comments.length %>)</h2>

  <% if (user) { %>
    <!-- コメント投稿フォーム -->
    <div class="comment-form-container">
      <h3>コメントを投稿</h3>
      <form action="/comments/<%= article._id %>" method="POST" class="comment-form">
        <div class="form-group">
          <textarea name="content" rows="4" placeholder="コメントを入力してください..." required></textarea>
        </div>
        <button type="submit" class="btn-primary">コメントを投稿</button>
      </form>
    </div>
  <% } else { %>
    <div class="comment-login-prompt">
      <p>コメントを投稿するには<a href="/auth/google">ログイン</a>してください</p>
    </div>
  <% } %>

  <!-- コメント一覧 -->
  <div class="comments-list">
    <% if (comments.length > 0) { %>
      <% comments.forEach(comment => { %>
        <div class="comment-item" id="comment-<%= comment._id %>">
          <div class="comment-header">
            <img src="<%= comment.author.image %>" alt="<%= (adminDisplayNames && adminDisplayNames[comment.author.email]) ? adminDisplayNames[comment.author.email] : comment.author.displayName %>" class="comment-avatar">
            <div class="comment-meta">
              <span class="comment-author"><%= (adminDisplayNames && adminDisplayNames[comment.author.email]) ? adminDisplayNames[comment.author.email] : comment.author.displayName %></span>
              <span class="comment-date"><%= new Date(comment.createdAt).toLocaleDateString('ja-JP') %> <%= new Date(comment.createdAt).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) %></span>
            </div>
            <% if (user && (comment.author._id.toString() === user.id || isAdmin)) { %>
              <form action="/comments/<%= comment._id %>?_method=DELETE" method="POST" class="comment-delete-form">
                <button type="submit" class="btn-comment-delete" onclick="return confirm('コメントを削除しますか？')">🗑️</button>
              </form>
            <% } %>
          </div>
          <div class="comment-content">
            <%= comment.content %>
          </div>

          <% if (user) { %>
            <details class="comment-reply" style="margin-top:0.75rem;">
              <summary class="btn-secondary" style="cursor:pointer; display:inline-block;">返信</summary>
              <form action="/comments/<%= article._id %>" method="POST" class="comment-form" style="margin-top:0.5rem;">
                <input type="hidden" name="parentId" value="<%= comment._id %>">
                <div class="form-group">
                  <textarea name="content" rows="3" placeholder="返信を入力してください..." required></textarea>
                </div>
                <button type="submit" class="btn-primary">返信を投稿</button>
              </form>
            </details>
          <% } %>

          <% if (comment.replies && comment.replies.length > 0) { %>
            <div class="comment-replies" style="margin-top:0.75rem; padding-left:1rem; border-left: 2px solid rgba(0,0,0,0.08);">
              <% comment.replies.forEach(reply => { %>
                <div class="comment-item" style="margin-top:0.75rem;" id="comment-<%= reply._id %>">
                  <div class="comment-header">
                    <img src="<%= reply.author.image %>" alt="<%= (adminDisplayNames && adminDisplayNames[reply.author.email]) ? adminDisplayNames[reply.author.email] : reply.author.displayName %>" class="comment-avatar">
                    <div class="comment-meta">
                      <span class="comment-author"><%= (adminDisplayNames && adminDisplayNames[reply.author.email]) ? adminDisplayNames[reply.author.email] : reply.author.displayName %></span>
                      <span class="comment-date"><%= new Date(reply.createdAt).toLocaleDateString('ja-JP') %> <%= new Date(reply.createdAt).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) %></span>
                    </div>
                    <% if (user && (reply.author._id.toString() === user.id || isAdmin)) { %>
                      <form action="/comments/<%= reply._id %>?_method=DELETE" method="POST" class="comment-delete-form">
                        <button type="submit" class="btn-comment-delete" onclick="return confirm('コメントを削除しますか？')">🗑️</button>
                      </form>
                    <% } %>
                  </div>
                  <div class="comment-content">
                    <%= reply.content %>
                  </div>
                </div>
              <% }); %>
            </div>
          <% } %>
        </div>
      <% }); %>
    <% } else { %>
      <div class="no-comments">
        <p>まだコメントがありません。最初のコメントを投稿してみましょう！</p>
      </div>
    <% } %>
  </div>
</section>

<script src="/js/relatedClickTracking.js"></script>
<script src="/js/shareLink.js"></script>
