<article class="article-detail" data-article-id="<%= article._id %>">
  <div class="article-header">
    <div class="breadcrumb">
      <a href="/">ホーム</a> / <span><%= article.gameTitle %></span>
    </div>
    
    <% if (article.imageUrl) { %>
      <div class="featured-image">
        <img src="<%= article.imageUrl %>" alt="<%= article.gameTitle %>">
      </div>
    <% } %>

    <div class="article-meta-header">
      <span class="genre"><%= article.genre || 'ゲーム' %></span>
      <% if (article.rating) { %>
        <span class="rating-large"><%= '★'.repeat(article.rating) + '☆'.repeat(10 - article.rating) %></span>
      <% } %>
    </div>

    <h1><%= article.title %></h1>
    <h2 class="game-title-large"><%= article.gameTitle %></h2>

    <div class="game-info">
      <% if (article.developer) { %>
        <div class="info-item">
          <strong>開発元:</strong> <%= article.developer %>
        </div>
      <% } %>
      <% if (article.platform) { %>
        <div class="info-item">
          <strong>プラットフォーム:</strong> <%= article.platform %>
        </div>
      <% } %>
      <% if (article.releaseDate) { %>
        <div class="info-item">
          <strong>発売日:</strong> <%= new Date(article.releaseDate).toLocaleDateString('ja-JP') %>
        </div>
      <% } %>
    </div>

    <div class="author-date">
      <div class="author-info">
        <img src="<%= article.author.image %>" alt="<%= (adminDisplayNames && adminDisplayNames[article.author.email]) ? adminDisplayNames[article.author.email] : article.author.displayName %>" class="author-avatar">
        <div>
          <div class="author-name"><%= (adminDisplayNames && adminDisplayNames[article.author.email]) ? adminDisplayNames[article.author.email] : article.author.displayName %></div>
          <div class="article-date">
            投稿: <%= new Date(article.createdAt).toLocaleDateString('ja-JP') %>
            <% if (article.createdAt.getTime() !== article.updatedAt.getTime()) { %>
              | 更新: <%= new Date(article.updatedAt).toLocaleDateString('ja-JP') %>
            <% } %>
          </div>
        </div>
      </div>
      <div class="views-count">👁️ <%= article.views %> 閲覧</div>
    </div>

    <div class="article-actions">
      <div
        class="share-menu-wrap"
        data-share-wrap="1"
        data-share-url="<%= canonicalUrl %>"
        data-share-text="<%= (article && (article.title || article.gameTitle)) ? (article.title || article.gameTitle) : '' %>"
      >
        <button
          type="button"
          class="share-btn"
          data-share-toggle="1"
          aria-label="共有"
          aria-haspopup="true"
          aria-expanded="false"
        >
          <span class="share-btn-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="18" height="18" focusable="false" aria-hidden="true">
              <path d="M14 3l7 7-7 7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M21 10H10a7 7 0 0 0-7 7v4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </span>
          <span class="share-btn-label">共有</span>
        </button>

        <div class="share-menu" data-share-menu="1" hidden>
          <a href="#" class="share-menu-item" data-share-line="1" target="_blank" rel="noopener noreferrer">
            <span class="share-menu-icon" aria-hidden="true">💬</span>
            <span class="share-menu-label">LINEで共有</span>
          </a>
          <a href="#" class="share-menu-item" data-share-x="1" target="_blank" rel="noopener noreferrer">
            <span class="share-menu-icon" aria-hidden="true">𝕏</span>
            <span class="share-menu-label">Xで共有</span>
          </a>
          <button type="button" class="share-menu-item" data-share-copy="1">
            <span class="share-menu-icon" aria-hidden="true">🔗</span>
            <span class="share-menu-label">URLをコピー</span>
          </button>
        </div>
      </div>
    </div>

    <% if (isAdmin) { %>
      <div class="article-actions">
        <a href="/articles/<%= article._id %>/edit" class="btn-edit">編集</a>
        <form action="/articles/<%= article._id %>?_method=DELETE" method="POST" style="display:inline;">
          <button type="submit" class="btn-delete" onclick="return confirm('本当に削除しますか？')">削除</button>
        </form>
      </div>
    <% } %>
  </div>

  <div class="article-body">
    <div class="description">
      <p><%= article.description %></p>
    </div>

    <div class="content">
      <%- article.contentHtml %>
    </div>

    <% if (article.tags && article.tags.length > 0) { %>
      <div class="tags">
        <strong>タグ:</strong>
        <% article.tags.forEach(tag => { %>
          <a class="tag" href="/articles?tags=<%= encodeURIComponent(tag) %>">#<%= tag %></a>
        <% }); %>
      </div>
    <% } %>

    <% if (article.affiliateLink) { %>
      <div class="affiliate-section">
        <h3>このゲームを購入</h3>
        <a href="<%= article.affiliateLink %>" target="_blank" rel="noopener noreferrer sponsored" class="btn-affiliate">
          🛒 購入ページへ
        </a>
      </div>
    <% } %>

    <% if (relatedVideos && relatedVideos.length > 0) { %>
      <section class="articles-section page-section" aria-label="関連動画">
        <div class="page-header">
          <h2 class="section-title">関連動画</h2>
          <p class="section-lead">タイトルの単語から関連動画を探しました。</p>
        </div>
        <div class="panel">
          <div class="panel-body">
            <div class="articles-grid">
              <% relatedVideos.forEach(function(v){ %>
                <article class="article-card">
                  <% if (v.thumbnailUrl) { %>
                    <div class="article-image">
                      <a href="<%= v.url %>" target="_blank" rel="noopener noreferrer">
                        <img src="<%= v.thumbnailUrl %>" alt="<%= v.title %>">
                      </a>
                    </div>
                  <% } %>
                  <div class="article-content">
                    <div class="article-meta">
                      <span class="genre">YouTube</span>
                      <% if (v.publishedAtJp) { %>
                        <span class="date"><%= v.publishedAtJp %></span>
                      <% } %>
                    </div>
                    <h2>
                      <a href="<%= v.url %>" target="_blank" rel="noopener noreferrer"><%= v.title %></a>
                    </h2>
                    <% if (v.shortDescription) { %>
                      <p class="description"><%= v.shortDescription %></p>
                    <% } %>
                    <a href="<%= v.url %>" target="_blank" rel="noopener noreferrer" class="btn-read-more">動画を見る</a>
                  </div>
                </article>
              <% }); %>
            </div>
          </div>
        </div>
      </section>
    <% } %>

    <section class="articles-section page-section" aria-label="同属性のおすすめ">
      <div class="page-header">
        <h2 class="section-title">同属性のおすすめ3本</h2>
        <p class="section-lead"><%= (article.genre && String(article.genre).trim()) ? (String(article.genre).trim() + ' の記事') : '関連する記事' %>をピックアップしました。</p>
      </div>
      <div class="panel">
        <div class="panel-body">
          <% if (recommendedSameAttribute && recommendedSameAttribute.length > 0) { %>
            <div class="articles-grid">
              <% recommendedSameAttribute.slice(0, 3).forEach(function(a, idx){ %>
                <article class="article-card">
                  <% if (a.imageUrl) { %>
                    <div class="article-image">
                      <img src="<%= a.imageUrl %>" alt="<%= a.gameTitle || a.title %>">
                    </div>
                  <% } %>
                  <div class="article-content">
                    <div class="article-meta">
                      <span class="genre"><%= a.genre || 'ゲーム' %></span>
                      <% if (a.rating) { %>
                        <span class="rating"><%= '★'.repeat(a.rating) + '☆'.repeat(10 - a.rating) %></span>
                      <% } %>
                    </div>
                    <h2><%= a.title %></h2>
                    <h3 class="game-title"><%= a.gameTitle %></h3>
                    <% if (a.description) { %>
                      <p class="description"><%= String(a.description).substring(0, 150) %>...</p>
                    <% } %>
                    <div class="article-footer">
                      <% if (a.author) { %>
                        <div class="author-info">
                          <img src="<%= a.author.image %>" alt="<%= (adminDisplayNames && adminDisplayNames[a.author.email]) ? adminDisplayNames[a.author.email] : a.author.displayName %>" class="author-avatar">
                          <span><%= (adminDisplayNames && adminDisplayNames[a.author.email]) ? adminDisplayNames[a.author.email] : a.author.displayName %></span>
                        </div>
                      <% } %>
                      <span class="date"><%= a.createdAt ? new Date(a.createdAt).toLocaleDateString('ja-JP') : '' %></span>
                    </div>
                    <a
                      href="/articles/<%= a._id %>"
                      class="btn-read-more"
                      data-related-click="1"
                      data-related-block="same_attribute"
                      data-related-position="<%= idx + 1 %>"
                      data-to-article-id="<%= a._id %>"
                    >続きを読む</a>
                  </div>
                </article>
              <% }); %>
            </div>
          <% } else { %>
            <div class="no-articles">
              <p>同属性のおすすめ記事がまだありません。</p>
            </div>
          <% } %>
        </div>
      </div>
    </section>

    <section class="articles-section page-section" aria-label="同サークルの他作">
      <div class="page-header">
        <h2 class="section-title">同サークルの他作3本</h2>
        <p class="section-lead"><%= (article.developer && String(article.developer).trim()) ? (String(article.developer).trim() + ' の他の記事') : '同じ制作元の他の記事' %>をピックアップしました。</p>
      </div>
      <div class="panel">
        <div class="panel-body">
          <% if (recommendedSameDeveloper && recommendedSameDeveloper.length > 0) { %>
            <div class="articles-grid">
              <% recommendedSameDeveloper.slice(0, 3).forEach(function(a, idx){ %>
                <article class="article-card">
                  <% if (a.imageUrl) { %>
                    <div class="article-image">
                      <img src="<%= a.imageUrl %>" alt="<%= a.gameTitle || a.title %>">
                    </div>
                  <% } %>
                  <div class="article-content">
                    <div class="article-meta">
                      <span class="genre"><%= a.genre || 'ゲーム' %></span>
                      <% if (a.rating) { %>
                        <span class="rating"><%= '★'.repeat(a.rating) + '☆'.repeat(10 - a.rating) %></span>
                      <% } %>
                    </div>
                    <h2><%= a.title %></h2>
                    <h3 class="game-title"><%= a.gameTitle %></h3>
                    <% if (a.description) { %>
                      <p class="description"><%= String(a.description).substring(0, 150) %>...</p>
                    <% } %>
                    <div class="article-footer">
                      <% if (a.author) { %>
                        <div class="author-info">
                          <img src="<%= a.author.image %>" alt="<%= (adminDisplayNames && adminDisplayNames[a.author.email]) ? adminDisplayNames[a.author.email] : a.author.displayName %>" class="author-avatar">
                          <span><%= (adminDisplayNames && adminDisplayNames[a.author.email]) ? adminDisplayNames[a.author.email] : a.author.displayName %></span>
                        </div>
                      <% } %>
                      <span class="date"><%= a.createdAt ? new Date(a.createdAt).toLocaleDateString('ja-JP') : '' %></span>
                    </div>
                    <a
                      href="/articles/<%= a._id %>"
                      class="btn-read-more"
                      data-related-click="1"
                      data-related-block="same_developer"
                      data-related-position="<%= idx + 1 %>"
                      data-to-article-id="<%= a._id %>"
                    >続きを読む</a>
                  </div>
                </article>
              <% }); %>
            </div>
          <% } else { %>
            <div class="no-articles">
              <p>同サークルの他作記事がまだありません。</p>
            </div>
          <% } %>
        </div>
      </div>
    </section>

    <div class="article-footer-nav">
      <a
        href="<%= (article.tags && article.tags.length > 0) ? ('/articles?tags=' + encodeURIComponent(article.tags.slice(0, 3).join(','))) : '/articles' %>"
        class="btn-back"
      >
        ← 同タグ一覧へ
      </a>
      <a
        href="<%= (article.developer && String(article.developer).trim()) ? ('/articles?q=' + encodeURIComponent(String(article.developer).trim())) : '/articles' %>"
        class="btn-back"
      >
        ← 同サークル一覧へ
      </a>
    </div>

    <div class="banner-article" aria-label="スポンサーリンク">
      <a rel="noopener sponsored" href="https://dlaf.jp/maniax/dlaf/=/aid/r18Hub/url/https%3A%2F%2Fwww.dlsite.com%2Fmaniax%2F%3Futm_medium%3Daffiliate%26utm_campaign%3Dbnlink%26utm_content%3Dbn_sp_300_250_dojin_01.gif" target="_blank">
        <img src="https://www.dlsite.com/img/male/dojin/bn_sp_300_250_dojin_01.gif" alt="同人誌、同人ゲーム、同人ソフトのダウンロードショップ - DLsite" width="300" height="250" border="0" />
      </a>
      <a rel="noopener sponsored" href="https://dlaf.jp/maniax/dlaf/=/aid/r18Hub/url/https%3A%2F%2Fwww.dlsite.com%2Fmaniax%2F%3Futm_medium%3Daffiliate%26utm_campaign%3Dbnlink%26utm_content%3Dbn_sp_300_250_dojin_01.gif" target="_blank">
        <img src="https://www.dlsite.com/img/female/dojin/bn_sp_300_250_dojin_01.gif" alt="同人誌、同人ゲーム、同人ソフトのダウンロードショップ - DLsite" width="300" height="250" border="0" />
      </a>
      <a rel="noopener sponsored" href="https://dlaf.jp/maniax/dlaf/=/aid/r18Hub/url/https%3A%2F%2Fwww.dlsite.com%2Fmaniax%2F%3Futm_medium%3Daffiliate%26utm_campaign%3Dbnlink%26utm_content%3Dbn_sp_300_250_eng_01.gif" target="_blank">
        <img src="https://www.dlsite.com/img/abroad/eng/bn_sp_300_250_eng_01.gif" alt="同人誌、同人ゲーム、同人ソフトのダウンロードショップ - DLsite" width="300" height="250" border="0" />
      </a>
    </div>
  </div>

  <div class="article-footer-nav">
    <a href="/" class="btn-back">← 記事一覧に戻る</a>
  </div>
</article>

<!-- コメントセクション -->
<section class="comments-section">
  <h2 class="comments-title">💬 コメント (<%= (typeof commentCount !== 'undefined') ? commentCount : comments.length %>)</h2>

  <% if (user) { %>
    <!-- コメント投稿フォーム -->
    <div class="comment-form-container">
      <h3>コメントを投稿</h3>
      <form action="/comments/<%= article._id %>" method="POST" class="comment-form">
        <div class="form-group">
          <textarea name="content" rows="4" placeholder="コメントを入力してください..." required></textarea>
        </div>
        <button type="submit" class="btn-primary">コメントを投稿</button>
      </form>
    </div>
  <% } else { %>
    <div class="comment-login-prompt">
      <p>コメントを投稿するには<a href="/auth/google">ログイン</a>してください</p>
    </div>
  <% } %>

  <!-- コメント一覧 -->
  <div class="comments-list">
    <% if (comments.length > 0) { %>
      <% comments.forEach(comment => { %>
        <div class="comment-item" id="comment-<%= comment._id %>">
          <div class="comment-header">
            <img src="<%= comment.author.image %>" alt="<%= (adminDisplayNames && adminDisplayNames[comment.author.email]) ? adminDisplayNames[comment.author.email] : comment.author.displayName %>" class="comment-avatar">
            <div class="comment-meta">
              <span class="comment-author"><%= (adminDisplayNames && adminDisplayNames[comment.author.email]) ? adminDisplayNames[comment.author.email] : comment.author.displayName %></span>
              <span class="comment-date"><%= new Date(comment.createdAt).toLocaleDateString('ja-JP') %> <%= new Date(comment.createdAt).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) %></span>
            </div>
            <% if (user && (comment.author._id.toString() === user.id || isAdmin)) { %>
              <form action="/comments/<%= comment._id %>?_method=DELETE" method="POST" class="comment-delete-form">
                <button type="submit" class="btn-comment-delete" onclick="return confirm('コメントを削除しますか？')">🗑️</button>
              </form>
            <% } %>
          </div>
          <div class="comment-content">
            <%= comment.content %>
          </div>

          <% if (user) { %>
            <details class="comment-reply" style="margin-top:0.75rem;">
              <summary class="btn-secondary" style="cursor:pointer; display:inline-block;">返信</summary>
              <form action="/comments/<%= article._id %>" method="POST" class="comment-form" style="margin-top:0.5rem;">
                <input type="hidden" name="parentId" value="<%= comment._id %>">
                <div class="form-group">
                  <textarea name="content" rows="3" placeholder="返信を入力してください..." required></textarea>
                </div>
                <button type="submit" class="btn-primary">返信を投稿</button>
              </form>
            </details>
          <% } %>

          <% if (comment.replies && comment.replies.length > 0) { %>
            <div class="comment-replies" style="margin-top:0.75rem; padding-left:1rem; border-left: 2px solid rgba(0,0,0,0.08);">
              <% comment.replies.forEach(reply => { %>
                <div class="comment-item" style="margin-top:0.75rem;" id="comment-<%= reply._id %>">
                  <div class="comment-header">
                    <img src="<%= reply.author.image %>" alt="<%= (adminDisplayNames && adminDisplayNames[reply.author.email]) ? adminDisplayNames[reply.author.email] : reply.author.displayName %>" class="comment-avatar">
                    <div class="comment-meta">
                      <span class="comment-author"><%= (adminDisplayNames && adminDisplayNames[reply.author.email]) ? adminDisplayNames[reply.author.email] : reply.author.displayName %></span>
                      <span class="comment-date"><%= new Date(reply.createdAt).toLocaleDateString('ja-JP') %> <%= new Date(reply.createdAt).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) %></span>
                    </div>
                    <% if (user && (reply.author._id.toString() === user.id || isAdmin)) { %>
                      <form action="/comments/<%= reply._id %>?_method=DELETE" method="POST" class="comment-delete-form">
                        <button type="submit" class="btn-comment-delete" onclick="return confirm('コメントを削除しますか？')">🗑️</button>
                      </form>
                    <% } %>
                  </div>
                  <div class="comment-content">
                    <%= reply.content %>
                  </div>
                </div>
              <% }); %>
            </div>
          <% } %>
        </div>
      <% }); %>
    <% } else { %>
      <div class="no-comments">
        <p>まだコメントがありません。最初のコメントを投稿してみましょう！</p>
      </div>
    <% } %>
  </div>
</section>

<script src="/js/relatedClickTracking.js"></script>
<script src="/js/shareLink.js"></script>
