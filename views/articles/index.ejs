<section class="articles-section page-section">
  <% function buildQs(overrides) {
       const q = Object.assign({}, query || {});
       for (const k in overrides) q[k] = overrides[k];
       const parts = [];
       for (const k in q) {
         if (q[k] === undefined || q[k] === null || q[k] === '') continue;
         parts.push(encodeURIComponent(k) + '=' + encodeURIComponent(q[k]));
       }
       return parts.length ? ('?' + parts.join('&')) : '';
     }
  %>

  <div class="page-header">
    <h1 class="section-title">記事一覧</h1>
    <p class="section-lead">レビューや攻略、特集記事を一覧で表示します。気になる記事を見つけて深掘りしましょう。</p>
  </div>

  <% const activeQueryText = (query && query.q) ? String(query.q).trim() : ''; %>
  <form class="search-form" method="get" action="/articles" role="search" aria-label="記事検索">
    <% if (query) { %>
      <% Object.keys(query).forEach(function(k){
           if (k === 'q' || k === 'page') return;
           const v = query[k];
           if (v === undefined || v === null || v === '') return;
           if (Array.isArray(v)) {
             v.forEach(function(item){ if (item !== undefined && item !== null && item !== '') { %>
               <input type="hidden" name="<%= k %>" value="<%= item %>">
             <% }});
           } else { %>
             <input type="hidden" name="<%= k %>" value="<%= v %>">
           <% }
         }); %>
    <% } %>
    <input type="search" name="q" placeholder="タイトル/ゲーム名/メーカーで検索" value="<%= activeQueryText %>">
    <button type="submit">検索</button>
  </form>

  <% if (typeof recommendedTags !== 'undefined' && recommendedTags && recommendedTags.length) { %>
    <div class="per-toggle" aria-label="人気タグ">
      <span class="per-label">人気タグ:</span>
      <% recommendedTags.slice(0, 10).forEach(function(tag){ %>
        <a class="per-button <%= activeTags.includes(tag) ? 'active' : '' %>" href="<%= buildQs({ tags: tag, tag: '', page: 1 }) %>">#<%= tag %></a>
      <% }); %>
    </div>
  <% } %>

  <div class="filters-toggle-row">
    <button type="button" class="per-button filters-toggle" data-filters-toggle aria-controls="articles-filters" aria-expanded="false">フィルターを表示</button>
  </div>

  <div class="per-toggle" aria-label="表示件数切替">
    <span class="per-label">表示件数:</span>
    <% const options = [10,30,50,100]; %>
    <% options.forEach(function(opt){ %>
      <a class="per-button <%= (typeof per !== 'undefined' && per === opt) ? 'active' : '' %>" href="<%= buildQs({ per: opt, page: 1 }) %>"><%= opt %></a>
    <% }); %>
  </div>

  <% const selectedTagsValue = (typeof selectedTags !== 'undefined' && selectedTags && selectedTags.length)
    ? selectedTags
    : ((query && query.tags) ? String(query.tags).split(',').map(t => String(t || '').trim().replace(/^#/, '')).filter(Boolean) : []);
  %>
  <% const activeTags = Array.from(new Set(selectedTagsValue)).filter(Boolean); %>

  <% const activeYear = (typeof selectedYear !== 'undefined' && selectedYear) ? Number(selectedYear) : ((query && query.year) ? parseInt(String(query.year), 10) : null); %>
  <% const activeMonth = (typeof selectedMonth !== 'undefined' && selectedMonth) ? Number(selectedMonth) : ((query && query.month) ? parseInt(String(query.month), 10) : null); %>

  <% if (activeTags && activeTags.length) { %>
    <% const tagLabel = activeTags.slice(0, 5).map(t => '#' + t).join('、'); %>
    <div class="panel" aria-label="タグ一覧の説明">
      <div class="panel-body">
        <p class="section-lead">
          このページでは、<%= tagLabel %> に関連するレビュー・攻略・特集記事をまとめています。気になる作品を見つけたら記事を開き、本文末尾の「同属性のおすすめ」「同サークルの他作」からさらに深掘りできます。タグは記事内容に基づき付与しているため、同じタグでも作品の方向性が異なる場合があります。自分に合うものから読んでみてください。
        </p>
      </div>
    </div>
  <% } %>

  <% if (activeTags.length || activeQueryText || (activeYear && !isNaN(activeYear)) || (activeMonth && !isNaN(activeMonth))) { %>
    <div class="per-toggle" aria-label="タグ絞り込み">
      <span class="per-label">絞り込み中:</span>
      <% if (activeQueryText) { %>
        <span class="tag">検索: <%= activeQueryText %></span>
      <% } %>
      <% if (activeYear && !isNaN(activeYear)) { %>
        <span class="tag"><%= activeYear %>年</span>
      <% } %>
      <% if (activeMonth && !isNaN(activeMonth)) { %>
        <span class="tag"><%= String(activeMonth).padStart(2,'0') %>月</span>
      <% } %>
      <% activeTags.forEach(function(t){ %>
        <span class="tag">#<%= t %></span>
      <% }); %>
    </div>
  <% } %>

  <% const selectedRatingsValue = (typeof selectedRatings !== 'undefined' && selectedRatings && selectedRatings.length)
    ? selectedRatings
    : ((query && query.ratings) ? String(query.ratings).split(',').map(r => parseInt(String(r || '').trim(), 10)).filter(n => n >= 1 && n <= 10) : []);
  %>
  <% const activeRatings = Array.from(new Set(selectedRatingsValue)).filter(n => n >= 1 && n <= 10).sort((a,b) => a-b); %>
  <% if (activeRatings.length) { %>
    <div class="per-toggle" aria-label="評価絞り込み">
      <span class="per-label">評価:</span>
      <% activeRatings.forEach(function(n){ %>
        <span class="tag"><%= '★'.repeat(n) %></span>
      <% }); %>
    </div>
  <% } %>

  <% function nextTagsForToggle(tag) {
       const current = activeTags.slice();
       const idx = current.indexOf(tag);
       if (idx >= 0) current.splice(idx, 1);
       else current.push(tag);
       return current.join(',');
     }
  %>

  <% function nextRatingsForToggle(n) {
       const current = activeRatings.slice();
       const idx = current.indexOf(n);
       if (idx >= 0) current.splice(idx, 1);
       else current.push(n);
       return current.sort((a,b) => a-b).join(',');
     }
  %>

  <div id="articles-filters" class="filters-panel" hidden>
    <% if (typeof availableYears !== 'undefined' && availableYears && availableYears.length) { %>
      <div class="per-toggle" aria-label="年フィルター">
        <span class="per-label">年:</span>
        <a class="per-button <%= (!activeYear || isNaN(activeYear)) ? 'active' : '' %>" href="<%= buildQs({ year: '', month: '', page: 1 }) %>">すべて</a>
        <% availableYears.forEach(function(y){ %>
          <a class="per-button <%= (activeYear === Number(y)) ? 'active' : '' %>" href="<%= buildQs({ year: y, month: '', page: 1 }) %>"><%= y %></a>
        <% }); %>
      </div>

      <% if (activeYear && !isNaN(activeYear) && typeof availableMonths !== 'undefined' && availableMonths && availableMonths.length) { %>
        <div class="per-toggle" aria-label="月フィルター">
          <span class="per-label">月:</span>
          <a class="per-button <%= (!activeMonth || isNaN(activeMonth)) ? 'active' : '' %>" href="<%= buildQs({ year: activeYear, month: '', page: 1 }) %>">すべて</a>
          <% availableMonths.forEach(function(m){ %>
            <a class="per-button <%= (activeMonth === Number(m)) ? 'active' : '' %>" href="<%= buildQs({ year: activeYear, month: m, page: 1 }) %>"><%= String(m).padStart(2,'0') %></a>
          <% }); %>
        </div>
      <% } %>
    <% } %>

    <% if (typeof recommendedTags !== 'undefined' && recommendedTags && recommendedTags.length) { %>
      <div class="per-toggle" aria-label="おすすめタグ">
        <span class="per-label">おすすめタグ:</span>
        <% recommendedTags.forEach(function(tag){ %>
          <a class="per-button <%= activeTags.includes(tag) ? 'active' : '' %>" href="<%= buildQs({ tags: nextTagsForToggle(tag), tag: '', page: 1 }) %>">#<%= tag %></a>
        <% }); %>
      </div>
    <% } %>

    <div class="per-toggle" aria-label="評価フィルター">
      <span class="per-label">評価:</span>
      <% for (let n = 1; n <= 10; n++) { %>
        <a class="per-button <%= activeRatings.includes(n) ? 'active' : '' %>" href="<%= buildQs({ ratings: nextRatingsForToggle(n), rating: '', page: 1 }) %>" title="★<%= n %>"><%= '★'.repeat(n) %></a>
      <% } %>
    </div>

    <div class="per-toggle" aria-label="並び替え">
      <span class="per-label">並び替え:</span>
      <% const currentSort = (typeof sortKey !== 'undefined' ? sortKey : (query && query.sort) || 'new'); %>
      <a class="per-button <%= currentSort === 'new' ? 'active' : '' %>" href="<%= buildQs({ sort: 'new', page: 1, per: per }) %>">新しい順</a>
      <a class="per-button <%= currentSort === 'old' ? 'active' : '' %>" href="<%= buildQs({ sort: 'old', page: 1, per: per }) %>">古い順</a>
      <a class="per-button <%= currentSort === 'release_new' ? 'active' : '' %>" href="<%= buildQs({ sort: 'release_new', page: 1, per: per }) %>">発売日(新しい順)</a>
      <a class="per-button <%= currentSort === 'release_old' ? 'active' : '' %>" href="<%= buildQs({ sort: 'release_old', page: 1, per: per }) %>">発売日(古い順)</a>
    </div>

  </div>

  <% if (articles && articles.length > 0) { %>
    <div class="articles-grid modern-grid">
      <% articles.forEach(function(article){ %>
        <div class="panel">
          <div class="panel-body">
            <article class="post-card">
          <a class="post-cover" href="/articles/<%= article._id %>">
            <% if (article.imageUrl) { %>
              <img src="<%= article.imageUrl %>" alt="<%= article.gameTitle %>">
            <% } else { %>
              <img src="/images/siteicon.png" alt="thumb">
            <% } %>
          </a>
          <div class="post-body">
            <div class="meta-row">
              <span class="tag genre"><%= article.genre || 'ゲーム' %></span>
              <% if (article.tags && article.tags.length) { %>
                <a class="tag" href="/articles?tags=<%= encodeURIComponent(article.tags[0]) %>">#<%= article.tags[0] %></a>
              <% } %>
              <% if (article.developer) { %>
                <a class="tag" href="/articles?q=<%= encodeURIComponent(article.developer) %>"><%= article.developer %></a>
              <% } %>
            </div>
            <h3 class="post-title"><a href="/articles/<%= article._id %>"><%= article.title %></a></h3>
            <div class="post-sub"> <%= article.gameTitle %> • <span class="date"><%= new Date(article.createdAt).toLocaleDateString('ja-JP') %></span></div>
            <p class="post-excerpt"><%= (article.description || '').replace(/<[^>]*>/g, '').slice(0,160) %><%= (article.description || '').length > 160 ? '…' : '' %></p>
            <div class="post-actions">
              <a class="btn-read-more" href="/articles/<%= article._id %>">続きを読む</a>
            </div>
          </div>
            </article>
          </div>
        </div>
      <% }); %>
    </div>
    <% /* pagination controls for articles list */ %>
    <% if (typeof totalCount !== 'undefined' && totalCount > per) { %>
      <nav class="pagination" aria-label="ページネーション">
        <% if (page > 1) { %>
          <a class="page-btn prev" href="<%= buildQs({ per: per, page: page - 1 }) %>">« 前へ</a>
        <% } else { %>
          <span class="page-btn disabled">« 前へ</span>
        <% } %>

        <% for (let p = 1; p <= totalPages; p++) { %>
          <% if (Math.abs(p - page) <= 2 || p === 1 || p === totalPages) { %>
            <a class="page-btn <%= p === page ? 'active' : '' %>" href="<%= buildQs({ per: per, page: p }) %>"><%= p %></a>
          <% } else if (p === 2 && page > 4) { %>
            <span class="ellipsis">…</span>
          <% } else if (p === totalPages - 1 && page < totalPages - 3) { %>
            <span class="ellipsis">…</span>
          <% } %>
        <% } %>

        <% if (page < totalPages) { %>
          <a class="page-btn next" href="<%= buildQs({ per: per, page: page + 1 }) %>">次へ »</a>
        <% } else { %>
          <span class="page-btn disabled">次へ »</span>
        <% } %>
      </nav>
    <% } %>
  <% } else { %>
    <div class="no-articles">
      <% const hasAnyFilter = !!(activeTags.length || activeQueryText || (activeYear && !isNaN(activeYear)) || (activeMonth && !isNaN(activeMonth)) || (activeRatings && activeRatings.length)); %>
      <% if (hasAnyFilter) { %>
        <p>条件に一致する記事が見つかりませんでした。</p>
        <p style="opacity:0.85;">検索語やフィルターを少し緩めると見つかりやすいです。</p>
        <div style="margin-top:0.5rem; display:flex; gap:0.5rem; flex-wrap:wrap;">
          <a class="btn-secondary" href="/articles">条件をリセット</a>
          <a class="btn-secondary" href="/review-ranking">みんなの評価を見る</a>
        </div>

        <% if ((typeof suggestDevelopers !== 'undefined' && suggestDevelopers && suggestDevelopers.length) || (typeof suggestGenres !== 'undefined' && suggestGenres && suggestGenres.length) || (typeof suggestTags !== 'undefined' && suggestTags && suggestTags.length)) { %>
          <div class="panel" style="margin-top:1rem;">
            <div class="panel-body">
              <p class="section-lead" style="margin:0 0 0.75rem;">近い候補</p>

              <% if (suggestDevelopers && suggestDevelopers.length) { %>
                <div class="per-toggle" aria-label="候補: サークル名">
                  <span class="per-label">サークル名:</span>
                  <% suggestDevelopers.forEach(function(d){ %>
                    <a class="per-button" href="<%= buildQs({ q: d, page: 1 }) %>"><%= d %></a>
                  <% }); %>
                </div>
              <% } %>

              <% if (suggestGenres && suggestGenres.length) { %>
                <div class="per-toggle" aria-label="候補: ジャンル">
                  <span class="per-label">ジャンル:</span>
                  <% suggestGenres.forEach(function(g){ %>
                    <a class="per-button" href="<%= buildQs({ q: g, page: 1 }) %>"><%= g %></a>
                  <% }); %>
                </div>
              <% } %>

              <% if (suggestTags && suggestTags.length) { %>
                <div class="per-toggle" aria-label="候補: タグ">
                  <span class="per-label">タグ:</span>
                  <% suggestTags.forEach(function(t){ %>
                    <a class="per-button" href="<%= buildQs({ tags: t, q: '', page: 1 }) %>">#<%= t %></a>
                  <% }); %>
                </div>
              <% } %>
            </div>
          </div>
        <% } %>
      <% } else { %>
        <p>まだ公開された記事がありません。</p>
      <% } %>
    </div>
  <% } %>
</section>

<script src="/js/articlesFiltersToggle.js"></script>
