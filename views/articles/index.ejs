<section class="articles-section page-section">
  <% function buildQs(overrides) {
       const q = Object.assign({}, query || {});
       for (const k in overrides) q[k] = overrides[k];
       const parts = [];
       for (const k in q) {
         if (q[k] === undefined || q[k] === null || q[k] === '') continue;
         parts.push(encodeURIComponent(k) + '=' + encodeURIComponent(q[k]));
       }
       return parts.length ? ('?' + parts.join('&')) : '';
     }
  %>

  <div class="page-header">
    <h1 class="section-title">記事一覧</h1>
    <p class="section-lead">レビューや攻略、特集記事を一覧で表示します。気になる記事を見つけて深掘りしましょう。</p>
  </div>

  <% const activeQueryText = (query && query.q) ? String(query.q).trim() : ''; %>
  <form class="search-form" method="get" action="/articles" role="search" aria-label="記事検索">
    <% if (query) { %>
      <% Object.keys(query).forEach(function(k){
           if (k === 'q' || k === 'page') return;
           const v = query[k];
           if (v === undefined || v === null || v === '') return;
           if (Array.isArray(v)) {
             v.forEach(function(item){ if (item !== undefined && item !== null && item !== '') { %>
               <input type="hidden" name="<%= k %>" value="<%= item %>">
             <% }});
           } else { %>
             <input type="hidden" name="<%= k %>" value="<%= v %>">
           <% }
         }); %>
    <% } %>
    <input type="search" name="q" placeholder="タイトル/ゲーム名/メーカーで検索" value="<%= activeQueryText %>">
    <button type="submit">検索</button>
  </form>

  <% const selectedTagsValue = (typeof selectedTags !== 'undefined' && selectedTags && selectedTags.length)
    ? selectedTags
    : ((query && query.tags) ? String(query.tags).split(',').map(t => String(t || '').trim().replace(/^#/, '')).filter(Boolean) : []);
  %>
  <% const activeTags = Array.from(new Set(selectedTagsValue)).filter(Boolean); %>
  <% if (activeTags.length || activeQueryText) { %>
    <div class="per-toggle" aria-label="タグ絞り込み">
      <span class="per-label">絞り込み中:</span>
      <% if (activeQueryText) { %>
        <span class="tag">検索: <%= activeQueryText %></span>
      <% } %>
      <% activeTags.forEach(function(t){ %>
        <span class="tag">#<%= t %></span>
      <% }); %>
    </div>
  <% } %>

  <% const selectedRatingsValue = (typeof selectedRatings !== 'undefined' && selectedRatings && selectedRatings.length)
    ? selectedRatings
    : ((query && query.ratings) ? String(query.ratings).split(',').map(r => parseInt(String(r || '').trim(), 10)).filter(n => n >= 1 && n <= 10) : []);
  %>
  <% const activeRatings = Array.from(new Set(selectedRatingsValue)).filter(n => n >= 1 && n <= 10).sort((a,b) => a-b); %>
  <% if (activeRatings.length) { %>
    <div class="per-toggle" aria-label="評価絞り込み">
      <span class="per-label">評価:</span>
      <% activeRatings.forEach(function(n){ %>
        <span class="tag"><%= '★'.repeat(n) %></span>
      <% }); %>
    </div>
  <% } %>

  <% function nextTagsForToggle(tag) {
       const current = activeTags.slice();
       const idx = current.indexOf(tag);
       if (idx >= 0) current.splice(idx, 1);
       else current.push(tag);
       return current.join(',');
     }
  %>

  <% function nextRatingsForToggle(n) {
       const current = activeRatings.slice();
       const idx = current.indexOf(n);
       if (idx >= 0) current.splice(idx, 1);
       else current.push(n);
       return current.sort((a,b) => a-b).join(',');
     }
  %>

  <% if (typeof recommendedTags !== 'undefined' && recommendedTags && recommendedTags.length) { %>
    <div class="per-toggle" aria-label="おすすめタグ">
      <span class="per-label">おすすめタグ:</span>
      <% recommendedTags.forEach(function(tag){ %>
        <a class="per-button <%= activeTags.includes(tag) ? 'active' : '' %>" href="<%= buildQs({ tags: nextTagsForToggle(tag), tag: '', page: 1 }) %>">#<%= tag %></a>
      <% }); %>
    </div>
  <% } %>

  <div class="per-toggle" aria-label="評価フィルター">
    <span class="per-label">評価:</span>
    <% for (let n = 1; n <= 10; n++) { %>
      <a class="per-button <%= activeRatings.includes(n) ? 'active' : '' %>" href="<%= buildQs({ ratings: nextRatingsForToggle(n), rating: '', page: 1 }) %>" title="★<%= n %>"><%= '★'.repeat(n) %></a>
    <% } %>
  </div>

  <div class="per-toggle" aria-label="並び替え">
    <span class="per-label">並び替え:</span>
    <% const currentSort = (typeof sortKey !== 'undefined' ? sortKey : (query && query.sort) || 'new'); %>
    <a class="per-button <%= currentSort === 'new' ? 'active' : '' %>" href="<%= buildQs({ sort: 'new', page: 1, per: per }) %>">新しい順</a>
    <a class="per-button <%= currentSort === 'old' ? 'active' : '' %>" href="<%= buildQs({ sort: 'old', page: 1, per: per }) %>">古い順</a>
    <a class="per-button <%= currentSort === 'release_new' ? 'active' : '' %>" href="<%= buildQs({ sort: 'release_new', page: 1, per: per }) %>">発売日(新しい順)</a>
    <a class="per-button <%= currentSort === 'release_old' ? 'active' : '' %>" href="<%= buildQs({ sort: 'release_old', page: 1, per: per }) %>">発売日(古い順)</a>
  </div>

  <div class="per-toggle" aria-label="表示件数切替">
    <span class="per-label">表示件数:</span>
    <% const options = [10,30,50,100]; %>
    <% options.forEach(function(opt){ %>
      <a class="per-button <%= (typeof per !== 'undefined' && per === opt) ? 'active' : '' %>" href="<%= buildQs({ per: opt, page: 1 }) %>"><%= opt %></a>
    <% }); %>
  </div>

  <% if (articles && articles.length > 0) { %>
    <div class="articles-grid modern-grid">
      <% articles.forEach(function(article){ %>
        <div class="panel">
          <div class="panel-body">
            <article class="post-card">
          <a class="post-cover" href="/articles/<%= article._id %>">
            <% if (article.imageUrl) { %>
              <img src="<%= article.imageUrl %>" alt="<%= article.gameTitle %>">
            <% } else { %>
              <img src="/images/siteicon.png" alt="thumb">
            <% } %>
          </a>
          <div class="post-body">
            <div class="meta-row">
              <span class="tag genre"><%= article.genre || 'ゲーム' %></span>
              <% if (article.tags && article.tags.length) { %>
                <span class="tag">#<%= article.tags[0] %></span>
              <% } %>
            </div>
            <h3 class="post-title"><a href="/articles/<%= article._id %>"><%= article.title %></a></h3>
            <div class="post-sub"> <%= article.gameTitle %> • <span class="date"><%= new Date(article.createdAt).toLocaleDateString('ja-JP') %></span></div>
            <p class="post-excerpt"><%= (article.description || '').replace(/<[^>]*>/g, '').slice(0,160) %><%= (article.description || '').length > 160 ? '…' : '' %></p>
            <div class="post-actions">
              <a class="btn-read-more" href="/articles/<%= article._id %>">続きを読む</a>
            </div>
          </div>
            </article>
          </div>
        </div>
      <% }); %>
    </div>
    <% /* pagination controls for articles list */ %>
    <% if (typeof totalCount !== 'undefined' && totalCount > per) { %>
      <nav class="pagination" aria-label="ページネーション">
        <% if (page > 1) { %>
          <a class="page-btn prev" href="<%= buildQs({ per: per, page: page - 1 }) %>">« 前へ</a>
        <% } else { %>
          <span class="page-btn disabled">« 前へ</span>
        <% } %>

        <% for (let p = 1; p <= totalPages; p++) { %>
          <% if (Math.abs(p - page) <= 2 || p === 1 || p === totalPages) { %>
            <a class="page-btn <%= p === page ? 'active' : '' %>" href="<%= buildQs({ per: per, page: p }) %>"><%= p %></a>
          <% } else if (p === 2 && page > 4) { %>
            <span class="ellipsis">…</span>
          <% } else if (p === totalPages - 1 && page < totalPages - 3) { %>
            <span class="ellipsis">…</span>
          <% } %>
        <% } %>

        <% if (page < totalPages) { %>
          <a class="page-btn next" href="<%= buildQs({ per: per, page: page + 1 }) %>">次へ »</a>
        <% } else { %>
          <span class="page-btn disabled">次へ »</span>
        <% } %>
      </nav>
    <% } %>
  <% } else { %>
    <div class="no-articles">
      <p>まだ公開された記事がありません。</p>
    </div>
  <% } %>
</section>
