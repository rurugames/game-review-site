<div class="generator-container">
  <div class="generator-header">
    <h1>ğŸ“ è¨˜äº‹è‡ªå‹•ç”Ÿæˆ</h1>
    <p>å¹´æœˆã‚’æŒ‡å®šã—ã¦R18 PCåŒäººã‚²ãƒ¼ãƒ ã®æ”»ç•¥ãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼è¨˜äº‹ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™</p>
  </div>

  <div class="generator-form">
    <div class="form-section">
      <h2>1. å¹´æœˆã‚’é¸æŠ</h2>
      <div class="date-selector">
        <div class="form-group">
          <label for="year">å¹´</label>
          <select id="year" name="year">
            <option value="2025" selected>2025å¹´</option>
            <option value="2024">2024å¹´</option>
            <option value="2023">2023å¹´</option>
          </select>
        </div>
        <div class="form-group">
          <label for="month">æœˆ</label>
          <select id="month" name="month">
            <option value="1">1æœˆ</option>
            <option value="2">2æœˆ</option>
            <option value="3">3æœˆ</option>
            <option value="4">4æœˆ</option>
            <option value="5">5æœˆ</option>
            <option value="6">6æœˆ</option>
            <option value="7">7æœˆ</option>
            <option value="8">8æœˆ</option>
            <option value="9">9æœˆ</option>
            <option value="10">10æœˆ</option>
            <option value="11">11æœˆ</option>
            <option value="12" selected>12æœˆ</option>
          </select>
        </div>
        <button id="fetchGamesBtn" class="btn-primary">ã‚²ãƒ¼ãƒ ã‚’å–å¾—</button>
      </div>
    </div>

    <div id="gamesSection" class="form-section" style="display: none;">
      <h2>2. ç”Ÿæˆã™ã‚‹ã‚²ãƒ¼ãƒ ã‚’é¸æŠ</h2>
      <div id="gamesLoading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>ã‚²ãƒ¼ãƒ æƒ…å ±ã‚’å–å¾—ä¸­...</p>
      </div>
      <div id="gamesCount" class="games-count" style="display: none;"></div>
      <div id="checkboxControls" class="checkbox-controls" style="display: none;">
        <button id="selectAllBtn" class="btn-secondary">å…¨é¸æŠ</button>
        <button id="deselectAllBtn" class="btn-secondary">å…¨è§£é™¤</button>
      </div>
      <div id="gamesList" class="games-list"></div>
      <button id="generateBtn" class="btn-primary" style="display: none;">é¸æŠã—ãŸã‚²ãƒ¼ãƒ ã®è¨˜äº‹ã‚’ç”Ÿæˆ</button>
    </div>

    <div id="resultsSection" class="form-section" style="display: none;">
      <h2>3. ç”Ÿæˆçµæœ</h2>
      <div id="generateLoading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>è¨˜äº‹ã‚’ç”Ÿæˆä¸­... (æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™)</p>
      </div>
      <div id="resultsList" class="results-list"></div>
    </div>
  </div>
</div>

<style>
.generator-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
}

.generator-header {
  text-align: center;
  margin-bottom: 3rem;
}

.generator-header h1 {
  font-size: 2.5rem;
  margin-bottom: 1rem;
}

.generator-header p {
  color: var(--text-secondary);
  font-size: 1.1rem;
}

.form-section {
  background: var(--card-background);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 2rem;
  margin-bottom: 2rem;
}

.form-section h2 {
  font-size: 1.5rem;
  margin-bottom: 1.5rem;
  color: var(--primary-color);
}

.date-selector {
  display: flex;
  gap: 1rem;
  align-items: flex-end;
}

.form-group {
  flex: 1;
}

.form-group label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 600;
}

.form-group select {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  background: var(--background);
  color: var(--text-primary);
  font-size: 1rem;
}

.games-list {
  display: grid;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.game-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: var(--background);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  transition: all 0.3s ease;
}

.game-item:hover {
  border-color: var(--primary-color);
  transform: translateX(5px);
}

.game-item input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.game-info {
  flex: 1;
}

.game-info h3 {
  font-size: 1.1rem;
  margin-bottom: 0.5rem;
}

.game-info p {
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.games-count {
  padding: 1rem;
  margin-bottom: 1rem;
  background: var(--background);
  border-left: 4px solid var(--primary-color);
  border-radius: 4px;
}

.games-count p {
  margin: 0.25rem 0;
  font-size: 0.95rem;
}

.games-count .highlight {
  color: var(--primary-color);
  font-weight: 600;
}

.games-count .filtered {
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.checkbox-controls {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
}

.loading {
  text-align: center;
  padding: 3rem;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 4px solid var(--border-color);
  border-top: 4px solid var(--primary-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 1rem;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.results-list {
  display: grid;
  gap: 1rem;
}

.result-item {
  padding: 1rem;
  background: var(--background);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.result-item.success {
  border-color: #10b981;
}

.result-item.error {
  border-color: #ef4444;
}

.result-info h3 {
  font-size: 1.1rem;
  margin-bottom: 0.25rem;
}

.result-info p {
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.btn-primary {
  padding: 0.75rem 1.5rem;
  background: var(--gradient-primary);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.btn-primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const fetchGamesBtn = document.getElementById('fetchGamesBtn');
  const generateBtn = document.getElementById('generateBtn');
  const gamesSection = document.getElementById('gamesSection');
  const gamesLoading = document.getElementById('gamesLoading');
  const gamesList = document.getElementById('gamesList');
  const resultsSection = document.getElementById('resultsSection');
  const generateLoading = document.getElementById('generateLoading');
  const resultsList = document.getElementById('resultsList');

  // ã‚²ãƒ¼ãƒ å–å¾—
  fetchGamesBtn.addEventListener('click', async function() {
    const year = document.getElementById('year').value;
    const month = document.getElementById('month').value;

    fetchGamesBtn.disabled = true;
    gamesSection.style.display = 'block';
    gamesLoading.style.display = 'block';
    gamesList.innerHTML = '';
    generateBtn.style.display = 'none';

    try {
      const response = await fetch('/generator/fetch-games', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ year, month })
      });

      const data = await response.json();

      if (data.success && data.games.length > 0) {
        // ä»¶æ•°æƒ…å ±ã‚’è¡¨ç¤º
        const gamesCount = document.getElementById('gamesCount');
        gamesCount.innerHTML = `
          <p><span class="highlight">${data.totalCount}ä»¶</span>ä¸­<span class="highlight">${data.displayCount}ä»¶</span>ã‚’è¡¨ç¤º</p>
          ${data.filteredCount > 0 ? `<p class="filtered">â€» ${data.filteredCount}ä»¶ã¯æ—¢ã«è¨˜äº‹ãŒå­˜åœ¨ã™ã‚‹ãŸã‚é™¤å¤–ã•ã‚Œã¦ã„ã¾ã™</p>` : ''}
        `;
        gamesCount.style.display = 'block';
        
        gamesList.innerHTML = data.games.map((game, index) => `
          <div class="game-item" data-game-index="${index}">
            <input type="checkbox" class="game-checkbox" data-game-index="${index}" checked>
            <div class="game-info">
              <h3>${game.title}</h3>
              <p>${game.circle || 'åˆ¶ä½œã‚µãƒ¼ã‚¯ãƒ«ä¸æ˜'} | ${game.releaseDate || ''}</p>
            </div>
          </div>
        `).join('');
        
        // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
        window.gamesData = data.games;
        
        generateBtn.style.display = 'block';
        document.getElementById('checkboxControls').style.display = 'flex';
      } else if (data.success && data.games.length === 0) {
        const gamesCount = document.getElementById('gamesCount');
        if (data.totalCount > 0) {
          gamesCount.innerHTML = `
            <p><span class="highlight">${data.totalCount}ä»¶</span>ä¸­<span class="highlight">0ä»¶</span>ã‚’è¡¨ç¤º</p>
            <p class="filtered">â€» ã™ã¹ã¦ã®ã‚²ãƒ¼ãƒ ã¯æ—¢ã«è¨˜äº‹ãŒå­˜åœ¨ã—ã¾ã™</p>
          `;
          gamesCount.style.display = 'block';
        } else {
          gamesCount.style.display = 'none';
        }
        gamesList.innerHTML = '<p>æŒ‡å®šã•ã‚ŒãŸå¹´æœˆã®ã‚²ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
        document.getElementById('checkboxControls').style.display = 'none';
      } else {
        document.getElementById('gamesCount').style.display = 'none';
        gamesList.innerHTML = '<p>æŒ‡å®šã•ã‚ŒãŸå¹´æœˆã®ã‚²ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
        document.getElementById('checkboxControls').style.display = 'none';
      }
    } catch (error) {
      console.error('ã‚¨ãƒ©ãƒ¼:', error);
      document.getElementById('gamesCount').style.display = 'none';
      gamesList.innerHTML = '<p style="color: #ef4444;">ã‚²ãƒ¼ãƒ æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
      document.getElementById('checkboxControls').style.display = 'none';
    } finally {
      gamesLoading.style.display = 'none';
      fetchGamesBtn.disabled = false;
    }
  });

  // è¨˜äº‹ç”Ÿæˆ
  generateBtn.addEventListener('click', async function() {
    console.log('ğŸ”˜ è¨˜äº‹ç”Ÿæˆãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
    
    const checkboxes = document.querySelectorAll('.game-checkbox:checked');
    console.log('âœ… ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸã‚²ãƒ¼ãƒ æ•°:', checkboxes.length);
    
    if (checkboxes.length === 0) {
      alert('å°‘ãªãã¨ã‚‚1ã¤ã®ã‚²ãƒ¼ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    // data-game-indexã‚’ä½¿ã£ã¦ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const games = Array.from(checkboxes).map(cb => {
      const index = parseInt(cb.getAttribute('data-game-index'));
      return window.gamesData[index];
    });
    console.log('ğŸ“¦ é€ä¿¡ã™ã‚‹ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿:', games);

    generateBtn.disabled = true;
    resultsSection.style.display = 'block';
    generateLoading.style.display = 'block';
    resultsList.innerHTML = '';

    try {
      console.log('ğŸ“¤ /generator/generate ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...');
      const response = await fetch('/generator/generate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ games })
      });

      console.log('ğŸ“¥ ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status);
      const data = await response.json();
      console.log('ğŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿:', data);

      if (data.success) {
        resultsList.innerHTML = data.articles.map(article => `
          <div class="result-item success">
            <div class="result-info">
              <h3>âœ… ${article.gameTitle}</h3>
              <p>${article.title}</p>
            </div>
            <a href="/articles/${article.id}" class="btn-primary" style="font-size: 0.9rem; padding: 0.5rem 1rem;">è¨˜äº‹ã‚’ç¢ºèª</a>
          </div>
        `).join('');
        
        if (data.count > 0) {
          resultsList.innerHTML += `<p style="text-align: center; margin-top: 1rem; color: var(--primary-color); font-weight: 600;">${data.count}ä»¶ã®è¨˜äº‹ã‚’ç”Ÿæˆã—ã¾ã—ãŸ(ä¸‹æ›¸ãã¨ã—ã¦ä¿å­˜)</p>`;
        }
      }
    } catch (error) {
      console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error);
      resultsList.innerHTML = '<p style="color: #ef4444;">è¨˜äº‹ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
    } finally {
      generateLoading.style.display = 'none';
      generateBtn.disabled = false;
    }
  });

  // å…¨é¸æŠãƒœã‚¿ãƒ³
  document.getElementById('selectAllBtn').addEventListener('click', function() {
    document.querySelectorAll('.game-checkbox').forEach(checkbox => {
      checkbox.checked = true;
    });
  });

  // å…¨è§£é™¤ãƒœã‚¿ãƒ³
  document.getElementById('deselectAllBtn').addEventListener('click', function() {
    document.querySelectorAll('.game-checkbox').forEach(checkbox => {
      checkbox.checked = false;
    });
  });
});
</script>
