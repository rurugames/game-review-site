<div class="panel" data-ranking-provider="dlsite-blogparts">
  <div class="panel-body dlsite-ranking-widgets">
    <div class="dlsite-ranking-widget">
      <script type="text/javascript">blogparts={"base":"https://www.dlsite.com/","type":"ranking","site":"maniax","query":{"period":"week"},"title":"同人ゲームランキング(R18)","display":"horizontal","detail":"1","column":"v","image":"large","count":"5","wrapper":"1","autorotate":true,"aid":"r18Hub"}</script><script type="text/javascript" src="https://www.dlsite.com/js/blogparts.js" charset="UTF-8"></script>
    </div>
    <div class="dlsite-ranking-widget">
      <script type="text/javascript">blogparts={"base":"https://www.dlsite.com/","type":"ranking","site":"pro","query":{"period":"week"},"title":"PCゲームランキング(R18)","display":"horizontal","detail":"1","column":"v","image":"large","count":"5","wrapper":"1","autorotate":true,"aid":"r18Hub"}</script><script type="text/javascript" src="https://www.dlsite.com/js/blogparts.js" charset="UTF-8"></script>
    </div>
    <div class="dlsite-ranking-widget">
      <script type="text/javascript">blogparts={"base":"https://www.dlsite.com/","type":"ranking","site":"books","query":{"period":"week"},"title":"成年コミックランキング(R18)","display":"horizontal","detail":"1","column":"v","image":"large","count":"5","wrapper":"1","autorotate":true,"aid":"r18Hub"}</script><script type="text/javascript" src="https://www.dlsite.com/js/blogparts.js" charset="UTF-8"></script>
    </div>
  </div>
</div>

<% 
  // JST基準で「今月」を作る
  const JST_OFFSET_MS = 9 * 60 * 60 * 1000;
  const _jst = new Date(Date.now() + JST_OFFSET_MS);
  const _y = _jst.getUTCFullYear();
  const _m = _jst.getUTCMonth() + 1;
%>

<section class="articles-section page-section" aria-label="クイック導線">
  <div class="page-header">
    <h2 class="section-title">最短で探す</h2>
    <p class="section-lead">買ってよかったを見つけるための最短ルートです。</p>
  </div>
  <div class="panel">
    <div class="panel-body" style="display:flex; gap:0.75rem; flex-wrap:wrap; align-items:center;">
      <a href="/review-ranking" class="btn-primary">みんなの評価を見る</a>
      <a href="/articles?year=<%= _y %>&month=<%= _m %>" class="btn-secondary">今月の新作を見る</a>
      <a href="/articles" class="btn-secondary">タグから探す</a>
    </div>
  </div>
</section>

<section class="articles-section page-section">
  <div class="page-header">
    <h2 class="section-title">最新記事</h2>
    <p class="section-lead">レビュー・記事をパネル形式で一覧表示します。気になる記事をクリックして詳細を確認してください。</p>
  </div>

  <div class="panel">
    <div class="panel-body">
      <div class="articles-grid">
        <% if (articles.length > 0) { %>
          <% articles.forEach(article => { %>
            <article class="article-card">
              <% if (article.imageUrl) { %>
                <div class="article-image">
                  <img src="<%= article.imageUrl %>" alt="<%= article.gameTitle %>">
                </div>
              <% } %>
              <div class="article-content">
                <div class="article-meta">
                  <span class="genre"><%= article.genre || 'ゲーム' %></span>
                  <% if (article.rating) { %>
                    <span class="rating"><%= '★'.repeat(article.rating) + '☆'.repeat(10 - article.rating) %></span>
                  <% } %>
                </div>
                <h2><%= article.title %></h2>
                <h3 class="game-title"><%= article.gameTitle %></h3>
                <p class="description"><%= article.description.substring(0, 150) %>...</p>
                <% if (article.tags && article.tags.length > 0) { %>
                  <div class="article-tags">
                    <% article.tags.slice(0, 3).forEach(tag => { %>
                      <span class="tag-small">#<%= tag %></span>
                    <% }); %>
                  </div>
                <% } %>
                <div class="article-footer">
                  <div class="author-info">
                    <img src="<%= article.author.image %>" alt="<%= (adminDisplayNames && adminDisplayNames[article.author.email]) ? adminDisplayNames[article.author.email] : article.author.displayName %>" class="author-avatar">
                    <span><%= (adminDisplayNames && adminDisplayNames[article.author.email]) ? adminDisplayNames[article.author.email] : article.author.displayName %></span>
                  </div>
                  <span class="date"><%= new Date(article.createdAt).toLocaleDateString('ja-JP') %></span>
                </div>
                <a href="/articles/<%= article._id %>" class="btn-read-more">続きを読む</a>
              </div>
            </article>
          <% }); %>
        <% } else { %>
          <div class="no-articles">
            <p>まだ記事がありません。</p>
            <% if (user) { %>
              <a href="/articles/new" class="btn-primary">最初の記事を作成する</a>
            <% } else { %>
              <a href="/auth/google" class="btn-primary">ログインして記事を作成</a>
            <% } %>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</section>

<% if (typeof reviewMonthlyBest !== 'undefined') { %>
<section class="articles-section page-section" aria-label="みんなの評価">
  <div class="page-header">
    <h2 class="section-title">みんなの評価（短評レビュー）</h2>
    <p class="section-lead">短評レビューから「買ってよかった」を探せます。<a href="/review-ranking">一覧を見る</a></p>
  </div>

  <div class="panel">
    <div class="panel-body">
      <% if (reviewMonthlyBest && reviewMonthlyBest.length > 0) { %>
        <div class="articles-grid">
          <% reviewMonthlyBest.forEach(item => { %>
            <% const a = item.article; %>
            <article class="article-card">
              <% if (a.imageUrl) { %>
                <div class="article-image"><img src="<%= a.imageUrl %>" alt="<%= a.gameTitle || a.title %>"></div>
              <% } %>
              <div class="article-content">
                <div class="article-meta">
                  <span class="genre"><%= a.genre || 'ゲーム' %></span>
                  <span class="rating">★<%= Number(item.score || 0).toFixed(2) %> / 5</span>
                </div>
                <h2><%= a.title %></h2>
                <h3 class="game-title"><%= a.gameTitle %></h3>
                <p class="description">レビュー <%= item.count %>件</p>
                <a href="/articles/<%= a._id %>#reviews" class="btn-read-more">短評レビューを見る</a>
              </div>
            </article>
          <% }); %>
        </div>
      <% } else { %>
        <div class="no-articles"><p>レビューがまだ集まっていません。</p></div>
      <% } %>
    </div>
  </div>
</section>
<% } %>

<% if (latestVideos && latestVideos.length > 0) { %>
<section class="articles-section page-section">
  <div class="page-header">
    <h2 class="section-title">新着動画</h2>
    <p class="section-lead">YouTubeの最新アップロード</p>
  </div>

  <div class="panel">
    <div class="panel-body">
      <div class="articles-grid">
        <% latestVideos.slice(0, 5).forEach(v => { %>
          <article class="article-card">
            <% if (v.thumbnailUrl) { %>
              <div class="article-image">
                <img src="<%= v.thumbnailUrl %>" alt="<%= v.title %>" loading="lazy">
              </div>
            <% } %>
            <div class="article-content">
              <div class="article-meta">
                <span class="genre">YouTube</span>
              </div>
              <h2><%= v.title %></h2>
              <% if (v.shortDescription) { %>
                <p class="description"><%= v.shortDescription %></p>
              <% } %>
              <div class="article-footer">
                <span class="date"><%= v.publishedAtJp || '' %></span>
              </div>
              <a href="<%= v.url %>" target="_blank" rel="noopener" class="btn-read-more">YouTubeで見る</a>
            </div>
          </article>
        <% }); %>
      </div>
    </div>
  </div>
</section>
<% } %>

<% if (recommendedVideos && recommendedVideos.length > 0) { %>
<section class="articles-section page-section">
  <div class="page-header">
    <h2 class="section-title">おすすめ動画</h2>
    <p class="section-lead">ピックアップ</p>
  </div>

  <div class="panel">
    <div class="panel-body">
      <div class="articles-grid">
        <% recommendedVideos.slice(0, 5).forEach(v => { %>
          <article class="article-card">
            <% if (v.thumbnailUrl) { %>
              <div class="article-image">
                <img src="<%= v.thumbnailUrl %>" alt="<%= v.title %>" loading="lazy">
              </div>
            <% } %>
            <div class="article-content">
              <div class="article-meta">
                <span class="genre">YouTube</span>
              </div>
              <h2><%= v.title %></h2>
              <% if (v.shortDescription) { %>
                <p class="description"><%= v.shortDescription %></p>
              <% } %>
              <div class="article-footer">
                <span class="date"><%= v.publishedAtJp || '' %></span>
              </div>
              <a href="<%= v.url %>" target="_blank" rel="noopener" class="btn-read-more">YouTubeで見る</a>
            </div>
          </article>
        <% }); %>
      </div>
    </div>
  </div>

  <% if (youtubeChannelId) { %>
    <div style="margin-top: 0.5rem;">
      <a class="btn-secondary" href="https://www.youtube.com/channel/<%= youtubeChannelId %>" target="_blank" rel="noopener">チャンネルを見る</a>
    </div>
  <% } %>
</section>
<% } %>

<!-- content wrapper is provided by layout.ejs -->
