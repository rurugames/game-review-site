# DLsite データ取得機能の実装

## 実装内容

DLsiteから実際のR18 PC同人ゲームのデータを取得する機能を実装しました。

### 主な機能

1. **検索URLによるデータ取得**
   - DLsiteの検索機能を使用して指定年月のゲームを取得
   - 成人向け（R18）PCゲームに絞り込み
   - 発売日の降順でソート

2. **HTMLパースによる情報抽出**
   - 作品ID（RJ番号）
   - タイトル
   - サークル名
   - 画像URL
   - 価格
   - 発売日
   - ジャンル（自動判定）

3. **エラーハンドリング**
   - DLsiteからの取得に失敗した場合、サンプルデータを返す
   - タイムアウト処理（10秒）
   - レート制限（1秒待機）

4. **ゲーム詳細取得**
   - 個別の作品ページから詳細情報を取得
   - 説明文、ジャンル、追加情報

### 技術詳細

#### スクレイピング対象URL
```
https://www.dlsite.com/maniax/fsr/=/language/jp/sex_category[0]/male/age_category[0]/adult/work_type[0]/PCG/from_sale/YYYY-MM-01/to_sale/YYYY-MM-31/order[0]/release_d/per_page/30/page/1
```

パラメータ:
- `sex_category[0]/male`: 男性向け
- `age_category[0]/adult`: 成人向け（R18）
- `work_type[0]/PCG`: PCゲーム
- `from_sale` / `to_sale`: 発売日範囲
- `order[0]/release_d`: 発売日降順
- `per_page/30`: 1ページ30件

#### 自動ジャンル判定

タイトルから以下のキーワードで判定:
- **RPG**: "rpg", "ＲＰＧ"
- **シミュレーション**: "slg", "SLG", "シミュレーション", "育成"
- **アドベンチャー**: "adv", "ADV", "アドベンチャー", "ノベル", "脱出", "探索"
- **アクション**: "act", "ACT", "アクション"
- **パズル**: "パズル", "puzzle"

### 使用上の注意

#### 1. 利用規約の遵守
DLsiteの利用規約とrobots.txtを確認し、以下を守ってください:
- 過度なアクセスを避ける（現在1秒間隔で実装）
- 商用利用の場合は適切な許可を取得
- スクレイピングが禁止されている場合は使用しない

#### 2. レート制限
現在の実装では各リクエスト間に1秒の待機時間を設けています。
大量のデータ取得を行う場合は、さらに間隔を空けることを推奨します。

#### 3. HTML構造の変更
DLsiteのHTML構造が変更された場合、スクレイピングが動作しなくなる可能性があります。
その場合は `dlsiteService.js` の以下のセレクターを更新してください:

```javascript
// 作品リスト
$('.n_worklist_item, .search_result_img_box_inner, li[class*="work"]')

// タイトル
$item.find('.work_name, .worktitle, [class*="title"]')

// サークル名
$item.find('.maker_name, .circle, [class*="maker"]')

// 画像
$item.find('img[src*="dlsite"]')

// 価格
$item.find('.work_price, .price, [class*="price"]')
```

#### 4. フォールバック機能
DLsiteからの取得に失敗した場合、自動的にサンプルデータが返されます。
エラーログを確認して原因を特定してください。

### テスト方法

1. 管理者でログイン
2. 「記事自動生成」メニューをクリック
3. 年月を選択（例: 2025年12月）
4. 「ゲームを取得」ボタンをクリック
5. コンソールログで以下を確認:
   ```
   DLsiteから2025年12月のゲームを取得中...
   DLsite検索URL: https://...
   X件のゲームを解析しました
   ```

### トラブルシューティング

#### ゲームが取得できない場合

1. **コンソールログを確認**
   ```
   DLsiteからの取得に失敗しました。サンプルデータを使用します
   ```
   というメッセージが表示される場合、以下を確認:

2. **DLsiteへのアクセス確認**
   - ブラウザで直接DLsiteにアクセスできるか
   - プロキシやファイアウォールで遮断されていないか
   - DLsiteのサーバーがメンテナンス中でないか

3. **HTML構造の変更**
   - DLsiteの検索結果ページを開いてHTML構造を確認
   - CSSセレクターが正しいか確認

4. **レート制限**
   - 短時間に多数のリクエストを送信するとブロックされる可能性
   - 待機時間を増やす（`sleep(1000)` → `sleep(3000)`など）

#### データが不完全な場合

一部の情報が取得できない場合、デフォルト値が使用されます:
- サークル名: "サークル名不明"
- ジャンル: タイトルから自動判定（デフォルト: "アドベンチャー"）
- 発売日: 月の中旬（15日）

### 今後の改善案

1. **キャッシュ機能**
   - 一度取得したデータをMongoDBに保存
   - 同じ年月の再リクエストを高速化

2. **複数ページ対応**
   - 現在は1ページ目のみ取得
   - ページネーション機能を追加

3. **並列処理**
   - 複数の月を同時に取得
   - Worker Threadsの活用

4. **公式API対応**
   - DLsite Affiliate APIが利用可能になった場合の実装
   - より安定したデータ取得

5. **詳細情報の強化**
   - レビュー数・評価の取得
   - タグ・カテゴリの詳細取得
   - サンプル画像の複数取得

### セキュリティとプライバシー

- User-Agentは一般的なブラウザを模倣
- 個人情報は取得・保存しない
- R18コンテンツのため、適切なアクセス制御が必要

## まとめ

実際のDLsiteデータを取得する機能を実装しました。
利用規約を遵守し、適切な間隔でアクセスしてください。
HTML構造の変更やアクセス制限に注意が必要です。

問題が発生した場合は、サンプルデータモードで動作し、
手動でのゲーム情報入力も可能です。
